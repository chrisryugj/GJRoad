<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì§„ì¶œë¡œ â€“ ì¶œì¥ê¸¸ ë„ìš°ë¯¸</title>
  <style>
    /* Modern CSS Reset & Base Styles */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: #333;
    }
    
    .app-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }
    
    /* Header Styles */
    .app-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .app-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1b3c82;
      margin-bottom: 5px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .app-title:hover {
      color: #4facfe;
    }
    
    .app-subtitle {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 15px;
    }
    
    /* Banner Styles */
    .app-banner {
      border-radius: 15px;
      padding: 0;
      margin: 15px 0 20px 0;
      overflow: hidden;
      position: relative;
      background: transparent;
    }
    
    .banner-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 15px;
    }
    
    /* Animations */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Mode Selection Styles */
    .mode-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .mode-card {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid transparent;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .mode-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .mode-card.active {
      border-color: #1b3c82;
      background: #1b3c82;
      color: white;
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(27, 60, 130, 0.3);
    }
    
    .mode-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .mode-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .mode-desc {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    /* Card Styles */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .card-icon {
      font-size: 1.5rem;
      color: #1b3c82;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .card-content {
      line-height: 1.6;
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #1b3c82;
      box-shadow: 0 0 0 3px rgba(27, 60, 130, 0.1);
      background: white;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 15px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      justify-content: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border: 2px solid #e1e5e9;
    }
    
    .btn-secondary:hover {
      background: white;
      border-color: #1b3c82;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      color: white;
    }
    
    .btn-full {
      width: 100%;
    }
    
    /* Map Selection Buttons */
    .map-option {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e1e5e9;
      border-radius: 15px;
      padding: 20px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-family: inherit;
    }
    
    .map-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #1b3c82;
    }
    
    .map-option.selected {
      background: #1b3c82;
      color: white;
      border-color: #1b3c82;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(27, 60, 130, 0.3);
    }
    
    .map-icon {
      width: 50px;
      height: 50px;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      overflow: hidden;
    }
    
    .map-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .map-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    /* Step Indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .step.completed {
      background: #4facfe;
      color: white;
    }
    
    .step.active {
      background: #1b3c82;
      color: white;
      transform: scale(1.1);
    }
    
    .step.pending {
      background: #f0f0f0;
      color: #999;
    }
    
    .step-line {
      width: 30px;
      height: 2px;
      background: #f0f0f0;
    }
    
    .step-line.completed {
      background: #4facfe;
    }
    
    /* Address Card Styles */
    .address-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 5px solid #e1e5e9;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .address-card:hover {
      transform: translateX(5px);
      border-left-color: #1b3c82;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .address-card.completed {
      border-left-color: #4facfe;
      background: rgba(79, 172, 254, 0.05);
    }
    
    .address-card.pending {
      border-left-color: #fa709a;
      background: rgba(250, 112, 154, 0.05);
    }
    
    .address-title {
      font-weight: 600;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .address-status {
      font-size: 0.9rem;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 500;
    }
    
    .status-completed {
      background: rgba(79, 172, 254, 0.2);
      color: #1b3c82;
    }
    
    .status-pending {
      background: rgba(250, 112, 154, 0.2);
      color: #c62828;
    }
    
    .status-none {
      background: rgba(0, 0, 0, 0.1);
      color: #666;
    }
    
    /* Photo Grid */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .photo-preview {
      width: 100%;
      height: 80px;
      border-radius: 10px;
      object-fit: cover;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.8);
    }
    
    .photo-preview:hover {
      transform: scale(1.05);
      border-color: #1b3c82;
    }
    
    /* Data Management Styles */
    .data-management {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(5px);
    }
    
    .data-status {
      font-size: 1rem;
      color: rgba(27, 60, 130, 0.8);
      font-weight: 500;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1b3c82;
      margin-bottom: 10px;
    }
    
    .modal-subtitle {
      color: #666;
      font-size: 0.95rem;
    }
    
    .option-grid {
      display: grid;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .option-card {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .option-card:hover {
      border-color: #1b3c82;
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .option-card.danger:hover {
      border-color: #e74c3c;
      background: rgba(231, 76, 60, 0.05);
    }
    
    .option-card.warning:hover {
      border-color: #f39c12;
      background: rgba(243, 156, 18, 0.05);
    }
    
    .option-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .option-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .option-desc {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Hide sections by default */
    .mode-section {
      display: none;
    }
    
    .mode-section.active {
      display: block;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
      }
      
      .mode-selector {
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 8px;
      }
      
      .mode-card {
        padding: 12px 8px;
        text-align: center;
      }
      
      .mode-icon {
        font-size: 1.8rem;
        margin-bottom: 5px;
      }
      
      .mode-title {
        font-size: 0.85rem;
        margin-bottom: 0;
      }
      
      .mode-desc {
        display: none;
      }
      
      .card {
        padding: 20px;
      }
      
      .app-title {
        font-size: 1.7rem;
      }
      
      .btn {
        padding: 12px 20px;
      }
      
      .map-button-selector {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 10px !important;
      }
      
      .map-option {
        padding: 15px 10px !important;
      }
      
      .map-name {
        font-size: 0.85rem !important;
      }
    }
    
    @media (max-width: 480px) {
      .mode-selector {
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 6px;
      }
      
      .mode-card {
        padding: 10px 6px;
      }
      
      .mode-icon {
        font-size: 1.5rem;
        margin-bottom: 3px;
      }
      
      .mode-title {
        font-size: 0.75rem;
      }
      
      .step-indicator {
        gap: 10px;
      }
      
      .step {
        width: 35px;
        height: 35px;
      }
      
      .step-line {
        width: 20px;
      }
    }
    
    /* Legacy styles for compatibility */
    .dropdown-item.memo-marked::after {
      content: "\1F4DD";
      float: right;
      margin-left: 8px;
      font-size: 1rem;
    }
    
    #customDropdown {
      position: absolute;
      z-index: 1000;
      background-color: white;
      width: calc(100% - 22px);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }
    header > div {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    header img {
      height: 36px;
      cursor: pointer;
    }
    header span {
      color: #1b3c82;
    }
    header .sub {
      color: #555;
    }
    #bannerImage {
      width: 100%;
      max-width: 100%;
      display: none;
      margin-top: 8px;
      border-radius: 8px;
    }
  .tabs {
  display: flex;
  justify-content: center;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 8px;
  margin-bottom: 10px;
}
.tabs button {
  flex: 0 1 auto; /* ì¤„ì–´ë“¤ê±°ë‚˜ ëŠ˜ì–´ë‚˜ì§€ ì•Šë„ë¡ ì¡°ì • */
  white-space: nowrap;
  padding: 8px 16px;
}
    .tabs button.active {
      background-color: #1b3c82;
      color: #fff;
    }
    .tab-content {
      display: none;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tab-content.active {
      display: block;
    }
    .card-ui {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 15px;
      margin-bottom: 15px;

    }
    input[type="text"], input[type="file"], select, button, textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #customStatusInput {
      background-color: #fff8dc;
      border-color: #f0c36d;
    }
    textarea {
      resize: vertical;
      height: 100px;
    }
    .dropdown-item {
      padding: 6px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .dropdown-item.viewed {
      background-color: #e0f7fa;
    }
    .status-marked {
      font-weight: bold;
    }
    canvas {
      width: 100%;
      max-width: 400px;
      height: auto;
      display: block;
      margin: 10px auto;
    }
    #chartTextOutput {
      margin-top: 10px;
      text-align: center;
      font-size: 0.9rem;
    }
tr.status-ì¶œì¥ì™„ë£Œ { background-color: #e8f5e9; }
tr.status-ë¯¸ì¶œì¥ { background-color: #ffebee; }
tr.status-ë¯¸ì„ íƒ { background-color: #eceff1; }

/* ê¸°íƒ€ ì§ì ‘ì…ë ¥ ìƒíƒœ (ì»¤ìŠ¤í…€) */
tr.status-ì§ì ‘ì…ë ¥ {
  background-color: #fff9c4; /* ì—°ë…¸ë‘ */
}
    footer {
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 12px;
      margin-top: 30px;
      font-size: 0.8rem;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- App Header -->
    <div class="app-header">
      <div class="app-title" onclick="goHome()">ì§„ì¶œë¡œ (é€²å‡ºè·¯)</div>
      <div class="app-subtitle">ì¶œì¥ê¸¸ ìŠ¤ë§ˆíŠ¸ ë„ìš°ë¯¸</div>
      
      <!-- Data Management Options -->
      <div id="data-management" class="data-management" style="margin: 20px 0;">
        <div class="data-status" id="data-status">
          <span>ğŸ—‚ï¸ <span id="total-addresses">0</span>ê°œ ì¶œì¥ì§€ ë“±ë¡ë¨</span>
        </div>
        <div class="data-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
          <button class="btn btn-secondary" onclick="showDataOptions()" id="manage-data-btn" style="padding: 8px 16px; font-size: 0.9rem;">
            âš™ï¸ ë°ì´í„° ê´€ë¦¬
          </button>
        </div>
      </div>
      
      <!-- Mode Selection -->
      <div class="mode-selector">
        <div class="mode-card active" data-mode="prepare" onclick="selectMode('prepare')">
          <span class="mode-icon">ğŸ“‹</span>
          <div class="mode-title">ì¤€ë¹„ëª¨ë“œ</div>
          <div class="mode-desc">ì¶œì¥ ì¤€ë¹„</div>
        </div>
        
        <div class="mode-card" data-mode="travel" onclick="selectMode('travel')">
          <span class="mode-icon">ğŸš—</span>
          <div class="mode-title">ì¶œì¥ëª¨ë“œ</div>
          <div class="mode-desc">í˜„ì¥ ì´ë™</div>
        </div>
        
        <div class="mode-card" data-mode="record" onclick="selectMode('record')">
          <span class="mode-icon">ğŸ“</span>
          <div class="mode-title">ê¸°ë¡ëª¨ë“œ</div>
          <div class="mode-desc">ë©”ëª¨ ì‘ì„±</div>
        </div>
        
        <div class="mode-card" data-mode="summary" onclick="selectMode('summary')">
          <span class="mode-icon">ğŸ“ˆ</span>
          <div class="mode-title">ì •ë¦¬ëª¨ë“œ</div>
          <div class="mode-desc">ë°ì´í„° ì •ë¦¬</div>
        </div>
      </div>
    </div>

    <!-- Prepare Mode -->
    <div id="mode-prepare" class="mode-section active">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" data-step="1">1</div>
        <div class="step-line"></div>
        <div class="step pending" data-step="2">2</div>
        <div class="step-line"></div>
        <div class="step pending" data-step="3">3</div>
      </div>
      
      <!-- Step 1: Map Selection -->
      <div class="card" id="step-map">
        <div class="card-header">
          <span class="card-icon">ğŸ—ºï¸</span>
          <h3 class="card-title">1ë‹¨ê³„: ì§€ë„ ì•± ì„ íƒ</h3>
        </div>
        <div class="card-content">
          <div class="form-group">
            <label class="form-label">ì‚¬ìš©í•  ì§€ë„ ì•±ì„ ì„ íƒí•˜ì„¸ìš”</label>
            
            <!-- Map Selection Buttons -->
            <div class="map-selector map-button-selector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <button class="map-option" data-map="naver" onclick="selectMapApp('naver')">
                <div class="map-icon">
                  <img src="https://chrisryugj.github.io/GJRoad/images/nmap.jpg" alt="ë„¤ì´ë²„ì§€ë„">
                </div>
                <div class="map-name">ë„¤ì´ë²„ì§€ë„</div>
              </button>
              
              <button class="map-option" data-map="kakao" onclick="selectMapApp('kakao')">
                <div class="map-icon">
                  <img src="https://chrisryugj.github.io/GJRoad/images/kmap.jpg" alt="ì¹´ì¹´ì˜¤ë§µ">
                </div>
                <div class="map-name">ì¹´ì¹´ì˜¤ë§µ</div>
              </button>
              
              <button class="map-option" data-map="google" onclick="selectMapApp('google')">
                <div class="map-icon">
                  <img src="https://chrisryugj.github.io/GJRoad/images/gmap.jpg" alt="êµ¬ê¸€ì§€ë„">
                </div>
                <div class="map-name">êµ¬ê¸€ì§€ë„</div>
              </button>
            </div>
            
            <!-- Remember Choice Checkbox -->
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
              <input type="checkbox" id="rememberMap" checked style="width: auto; transform: scale(1.2);">
              <label for="rememberMap" style="margin: 0; font-size: 0.95rem; color: #666;">
                âœ… ì„ íƒí•œ ì§€ë„ ì•±ì„ ê¸°ì–µí•˜ê¸°
              </label>
            </div>
            
            <!-- Continue Button -->
            <button id="continueStep2" class="btn btn-primary btn-full" onclick="nextStep(2)" style="display: none;">
              â¡ï¸ 2ë‹¨ê³„ë¡œ ê³„ì†
            </button>
            
            <!-- Hidden select for compatibility -->
            <select id="mapSelect" style="display: none;">
              <option value="naver">ë„¤ì´ë²„ì§€ë„</option>
              <option value="kakao">ì¹´ì¹´ì˜¤ë§µ</option>
              <option value="google">êµ¬ê¸€ì§€ë„</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Step 2: Address Input -->
      <div class="card" id="step-input" style="display: none;">
        <div class="card-header">
          <span class="card-icon">ğŸ </span>
          <h3 class="card-title">2ë‹¨ê³„: ì¶œì¥ì§€ ì…ë ¥</h3>
        </div>
        <div class="card-content">
          <!-- Default: Single Address Input -->
          <div class="form-group">
            <label class="form-label">ê°œë³„ ì…ë ¥</label>
            <input type="text" id="singleAddress" class="form-input" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button class="btn btn-success btn-full" onclick="addSingleAddress()" style="margin-top: 10px;">
              â• ì¶œì¥ì§€ ì¶”ê°€
            </button>
          </div>
          <div id="added-addresses" class="form-group"></div>
          <button class="btn btn-primary btn-full" onclick="completeAddressInput()" style="display: none;" id="complete-btn">
            âœ“ ì…ë ¥ ì™„ë£Œ
          </button>
          
          <!-- Alternative Methods -->
          <div style="margin-top: 30px; border-top: 2px solid #f0f0f0; padding-top: 20px;">
            <div class="form-label" style="margin-bottom: 15px;">ë‹¤ë¥¸ ì…ë ¥ ë°©ë²•</div>
            <div style="display: grid; gap: 10px;">
              <button class="btn btn-secondary" onclick="toggleInputMethod('file')">
                ğŸ“ íŒŒì¼ ì—…ë¡œë“œ
              </button>
              <button class="btn btn-secondary" onclick="toggleInputMethod('bulk')">
                ğŸ“‹ ì¼ê´„ ë¶™ì—¬ë„£ê¸°
              </button>
            </div>
          </div>
          
          <!-- File Upload (Hidden by default) -->
          <div id="file-input-section" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.05); border-radius: 12px;">
            <div class="form-group">
              <label class="form-label">TXT ë˜ëŠ” CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</label>
              <input type="file" id="fileUpload" class="form-input" accept=".txt,.csv" onchange="loadAddressFile(event)">
            </div>
          </div>
          
          <!-- Bulk Paste (Hidden by default) -->
          <div id="bulk-input-section" style="display: none; margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.05); border-radius: 12px;">
            <div class="form-group">
              <label class="form-label">ì£¼ì†Œë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”</label>
              <textarea id="bulkPaste" class="form-textarea" placeholder="ì˜ˆ:
ì„œìš¸ì‹œ ê´‘ì§„êµ¬ êµ¬ì˜ë™ 123
ì„œìš¸ì‹œ ê´‘ì§„êµ¬ ìì–‘ë™ 456
..."></textarea>
              <button class="btn btn-success btn-full" onclick="addFromTextarea()" style="margin-top: 10px;">
                ğŸ’¾ ì¶œì¥ì§€ ì €ì¥
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Step 3: Address List Preview -->
      <div class="card" id="step-preview" style="display: none;">
        <div class="card-header">
          <span class="card-icon">ğŸ“‹</span>
          <h3 class="card-title">3ë‹¨ê³„: ì¶œì¥ì§€ ëª©ë¡ í™•ì¸</h3>
        </div>
        <div class="card-content">
          <div id="address-preview-list"></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
            <button class="btn btn-danger" onclick="resetAddressList()">
              ğŸ—‘ï¸ ëª©ë¡ ì´ˆê¸°í™”
            </button>
            <button class="btn btn-primary" onclick="selectMode('travel')">
              ğŸš— ì¶œì¥ ì‹œì‘
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Travel Mode -->
    <div id="mode-travel" class="mode-section">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">ğŸš—</span>
          <h3 class="card-title">ì¶œì¥ì§€ ëª©ë¡</h3>
          <button class="btn btn-success" onclick="showOptimalRouteModal()" style="margin-left: auto; padding: 8px 16px; font-size: 0.9rem;" title="AIê°€ ìµœì  ê²½ë¡œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤">
            ğŸ—ºï¸ ìµœì ê²½ë¡œ ì¶”ì²œ
          </button>
        </div>
        <div class="card-content">
          <div id="travel-address-list"></div>
        </div>
      </div>
    </div>
    
    <!-- Record Mode -->
    <div id="mode-record" class="mode-section">
      <div class="card" id="record-card">
        <div class="card-header">
          <span class="card-icon">ğŸ“</span>
          <h3 class="card-title" id="record-title">ê¸°ë¡ ì‘ì„±</h3>
        </div>
        <div class="card-content">
          <div class="form-group">
            <label class="form-label">ì¶œì¥ ìƒíƒœ ì„ íƒ</label>
            <select id="recordStatusSelect" class="form-select" onchange="handleRecordStatusChange()">
              <option value="" disabled selected>ìƒíƒœ ì„ íƒ</option>
              <option value="ì¶œì¥ì™„ë£Œ">ì¶œì¥ì™„ë£Œ</option>
              <option value="ë¯¸ì¶œì¥">ë¯¸ì¶œì¥</option>
              <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
            </select>
            <input type="text" id="customRecordStatus" class="form-input" placeholder="ìƒíƒœ ì§ì ‘ ì…ë ¥" style="display: none; margin-top: 10px;">
          </div>
          
          <div class="form-group">
            <label class="form-label">í˜„ì¥ ë©”ëª¨</label>
            <textarea id="recordMemo" class="form-textarea" placeholder="í˜„ì¥ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì°¸ê³  ë©”ëª¨ë¥¼ ë‚¨ê¸°ì„¸ìš”"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">í˜„ì¥ ì‚¬ì§„ (ìµœëŒ€ 5ì¥)</label>
            <input type="file" id="recordPhotoInput" class="form-input" accept="image/*" multiple onchange="saveRecordPhoto()">
            <div id="recordPhotoContainer" class="photo-grid"></div>
          </div>
          
          <button class="btn btn-success btn-full" onclick="saveRecord()">
            ğŸ’¾ ê¸°ë¡ ì €ì¥
          </button>
        </div>
      </div>
    </div>
    
    <!-- Summary Mode -->
    <div id="mode-summary" class="mode-section">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">ğŸ“ˆ</span>
          <h3 class="card-title">ì¶œì¥ í†µê³„</h3>
        </div>
        <div class="card-content">
          <div id="statsCount" style="text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 1.2rem;"></div>
          <canvas id="statusChart" width="400" height="300"></canvas>
          <div id="chartTextOutput" style="text-align: center; margin-top: 15px; font-size: 0.95rem;"></div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="card-icon">ğŸ“Š</span>
          <h3 class="card-title">ì „ì²´ ëª©ë¡</h3>
        </div>
        <div class="card-content">
          <div id="tableSummary" style="text-align: center; margin-bottom: 20px; font-weight: 600;"></div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="copyTable()">
              ğŸ“„ ë³µì‚¬í•˜ê¸°
            </button>
            <button class="btn btn-secondary" onclick="exportText()">
              ğŸ“ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ
            </button>
            <button class="btn btn-success" onclick="exportExcel()">
              ğŸ“… ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ
            </button>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
              <thead>
                <tr style="background: rgba(27, 60, 130, 0.1); border-bottom: 2px solid #1b3c82;">
                  <th style="padding: 15px; text-align: center; font-weight: 600; width: 60px;">ìˆœì„œ</th>
                  <th style="padding: 15px; text-align: left; font-weight: 600;">ì£¼ì†Œ</th>
                  <th style="padding: 15px; text-align: left; font-weight: 600;">ìƒíƒœ</th>
                  <th style="padding: 15px; text-align: left; font-weight: 600;">ë©”ëª¨</th>
                  <th style="padding: 15px; text-align: left; font-weight: 600;">ì‚¬ì§„</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Hidden elements for compatibility -->
  <div style="display: none;">
    <!-- Legacy elements for compatibility -->
    <input id="addrInput" name="no_autofill" type="text" style="display: none;">
    <div id="memoSection" style="display: none;">
      <textarea id="memoInput"></textarea>
      <input type="file" id="photoInput" accept="image/*" multiple>
      <div id="photoContainer" class="photo-grid"></div>
    </div>
    <div id="customDropdown" style="display: none;"></div>
    <select id="statusSelect" style="display: none;">
      <option value="">ì„ íƒ</option>
      <option value="ì¶œì¥ì™„ë£Œ">ì¶œì¥ì™„ë£Œ</option>
      <option value="ë¯¸ì¶œì¥">ë¯¸ì¶œì¥</option>
      <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥</option>
    </select>
    <input id="customStatusInput" type="text" style="display: none;">
</div>

  
  <!-- Data Management Modal -->
  <div id="dataModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ“Š ë°ì´í„° ê´€ë¦¬</div>
        <div class="modal-subtitle">ì¶œì¥ ê¸°ë¡ì„ ê´€ë¦¬í•˜ê±°ë‚˜ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
      </div>
      
      <div class="option-grid">
        <div class="option-card" onclick="continueWithExistingData()">
          <div class="option-icon">âœ…</div>
          <div class="option-title">ê¸°ì¡´ ë°ì´í„°ë¡œ ê³„ì†í•˜ê¸°</div>
          <div class="option-desc">ì €ì¥ëœ ì¶œì¥ì§€ì™€ ê¸°ë¡ì„ ìœ ì§€í•©ë‹ˆë‹¤</div>
        </div>
        
        <div class="option-card warning" onclick="showResetOptions()">
          <div class="option-icon">ğŸ”„</div>
          <div class="option-title">ë°ì´í„° ì´ˆê¸°í™”</div>
          <div class="option-desc">ì¼ë¶€ ë˜ëŠ” ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤</div>
        </div>
      </div>
      
      <div style="text-align: center;">
        <button class="btn btn-secondary" onclick="closeModal()">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>
  
  <!-- Reset Options Modal -->
  <div id="resetModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™” ì˜µì…˜</div>
        <div class="modal-subtitle">ì´ˆê¸°í™”í•  ë°ì´í„° ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
      
      <div class="option-grid">
        <div class="option-card" onclick="showAddressSelector()">
          <div class="option-icon">ğŸ¯</div>
          <div class="option-title">ì„ íƒ ì´ˆê¸°í™”</div>
          <div class="option-desc">íŠ¹ì • ì¶œì¥ì§€ì˜ ê¸°ë¡ë§Œ ì‚­ì œí•©ë‹ˆë‹¤</div>
        </div>
        
        <div class="option-card danger" onclick="confirmFullReset()">
          <div class="option-icon">ğŸ’¥</div>
          <div class="option-title">ì „ì²´ ì´ˆê¸°í™”</div>
          <div class="option-desc">ëª¨ë“  ì¶œì¥ì§€ì™€ ê¸°ë¡ì„ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤</div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-secondary" onclick="showResetOptions()">
          â† ë’¤ë¡œ
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>
  
  <!-- Address Selector Modal -->
  <div id="addressSelectorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ¯ ì¶œì¥ì§€ ì„ íƒ</div>
        <div class="modal-subtitle">ì´ˆê¸°í™”í•  ì¶œì¥ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      </div>
      
      <div id="address-selector-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
        <!-- Address list will be populated here -->
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-danger" onclick="resetSelectedAddresses()" id="reset-selected-btn" style="display: none;">
          ğŸ—‘ï¸ ì„ íƒëœ í•­ëª© ì‚­ì œ
        </button>
        <button class="btn btn-secondary" onclick="showResetOptions()">
          â† ë’¤ë¡œ
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>
  
  <!-- Optimal Route Modal -->
  <div id="optimalRouteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ—ºï¸ ìµœì ê²½ë¡œ ì¶”ì²œ</div>
        <div class="modal-subtitle">AIê°€ ê°€ì¥ íš¨ìœ¨ì ì¸ ì¶œì¥ ê²½ë¡œë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤</div>
      </div>
      
      <div class="form-group" style="margin-bottom: 25px;">
        <label class="form-label">ì¶œë°œì§€ ê¸°ì¤€</label>
        <input type="text" id="startLocation" class="form-input" placeholder="ì¶œë°œì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" value="ì•„ì°¨ì‚°ë¡œ 400">
        <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
          ğŸ“ í˜„ì¬ ìœ„ì¹˜ ë˜ëŠ” ìì£¼ ì¶œë°œí•˜ëŠ” ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”
        </div>
      </div>
      
      <div style="background: rgba(79, 172, 254, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 25px;">
        <div style="font-size: 0.9rem; color: #1b3c82;">
          <strong>ğŸ“‹ ë¶„ì„í•  ì¶œì¥ì§€ (ì´ <span id="route-address-count">0</span>ê³³)</strong>
        </div>
        <div id="route-address-preview" style="margin-top: 10px; font-size: 0.85rem; color: #666;">
          <!-- Address list preview will be shown here -->
        </div>
      </div>
      
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button class="btn btn-success btn-full" onclick="calculateOptimalRoute()" id="calculate-route-btn">
          ğŸ¤– AI ìµœì ê²½ë¡œ ê³„ì‚°í•˜ê¸°
        </button>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
        <button class="btn btn-secondary" onclick="compareRouteAlgorithms()" style="font-size: 0.85rem;">
          ğŸ” ì•Œê³ ë¦¬ì¦˜ ë¹„êµ
        </button>
        <button class="btn btn-secondary" onclick="showManualRouteEditor()" style="font-size: 0.85rem;">
          âœï¸ ìˆ˜ë™ í¸ì§‘
        </button>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
        <button class="btn btn-secondary" onclick="testAPIConnection()" style="font-size: 0.85rem;">
          ğŸ”— API ì—°ê²° í…ŒìŠ¤íŠ¸
        </button>
        <button class="btn btn-secondary" onclick="downloadDebugLogs()" style="font-size: 0.85rem;">
          ğŸ“‹ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          ì·¨ì†Œ
        </button>
      </div>
      
      <!-- Loading indicator -->
      <div id="route-loading" style="display: none; text-align: center; margin-top: 20px;">
        <div style="font-size: 2rem; animation: spin 1s linear infinite;">âš™ï¸</div>
        <div style="margin-top: 10px; color: #666;">AIê°€ ìµœì ê²½ë¡œë¥¼ ê³„ì‚°ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
    </div>
  </div>
  
  <footer style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
    Â© 2025 ê´‘ì§„êµ¬ì²­ ê°€ë¡œê²½ê´€ê³¼ Â· ì§„ì¶œë¡œ v2.0
  </footer>
  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// App State Management
const AppState = {
  currentMode: 'prepare',
  currentStep: 1,
  currentAddress: null,
  inputMethod: null
};

// Data Storage
const originalPhotoMap = {};
let preferredMap = localStorage.getItem("preferredMap") || "naver";
let statusMap = JSON.parse(localStorage.getItem("statusMap")) || {};
let memoMap = JSON.parse(localStorage.getItem("memoMap")) || {};
let photoMap = JSON.parse(localStorage.getItem("photoMap")) || {};
let ì£¼ì†Œëª©ë¡ = JSON.parse(localStorage.getItem("addressList")) || [];
let viewedAddresses = new Set(JSON.parse(localStorage.getItem("viewedAddresses")) || []);

// Mode Management Functions
function selectMode(mode) {
  // Update UI
  document.querySelectorAll('.mode-card').forEach(card => {
    card.classList.remove('active');
  });
  document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
  
  // Show/Hide sections
  document.querySelectorAll('.mode-section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(`mode-${mode}`).classList.add('active');
  
  AppState.currentMode = mode;
  
  // Initialize mode-specific content
  if (mode === 'travel') {
    updateTravelMode();
  } else if (mode === 'summary') {
    // Add small delay to ensure DOM is ready
    setTimeout(() => {
      updateSummaryMode();
    }, 100);
  } else if (mode === 'prepare') {
    // Show selected map app if exists
    updateMapSelection();
  }
}

function goHome() {
  // Reset to initial prepare mode state
  AppState.currentStep = 1;
  AppState.currentAddress = null;
  
  selectMode('prepare');
  
  // Reset step indicator
  updateStepIndicator();
  
  // Show step 1, hide others
  document.getElementById('step-map').style.display = 'block';
  document.getElementById('step-input').style.display = 'none';
  document.getElementById('step-preview').style.display = 'none';
  
  // Hide input sections
  document.getElementById('file-input-section').style.display = 'none';
  document.getElementById('bulk-input-section').style.display = 'none';
}

// Map Selection Functions
function selectMapApp(mapType) {
  preferredMap = mapType;
  
  // Update UI
  document.querySelectorAll('.map-option').forEach(btn => {
    btn.classList.remove('selected');
  });
  document.querySelector(`[data-map="${mapType}"]`).classList.add('selected');
  
  // Update hidden select for compatibility
  document.getElementById('mapSelect').value = mapType;
  
  // Show continue button
  document.getElementById('continueStep2').style.display = 'block';
  
  // Save preference if checkbox is checked
  if (document.getElementById('rememberMap').checked) {
    localStorage.setItem('preferredMap', preferredMap);
  }
}

function updateMapSelection() {
  // Restore selected map
  if (preferredMap) {
    document.querySelectorAll('.map-option').forEach(btn => {
      btn.classList.remove('selected');
    });
    const selectedBtn = document.querySelector(`[data-map="${preferredMap}"]`);
    if (selectedBtn) {
      selectedBtn.classList.add('selected');
      document.getElementById('continueStep2').style.display = 'block';
    }
  }
}

// Step Management for Prepare Mode
function nextStep(step) {
  AppState.currentStep = step;
  updateStepIndicator();
  
  if (step === 2) {
    document.getElementById('step-map').style.display = 'none';
    document.getElementById('step-input').style.display = 'block';
  } else if (step === 3) {
    document.getElementById('step-input').style.display = 'none';
    document.getElementById('address-input-forms').style.display = 'none';
    document.getElementById('step-preview').style.display = 'block';
    updateAddressPreview();
  }
}

function updateStepIndicator() {
  document.querySelectorAll('.step').forEach((step, index) => {
    const stepNum = index + 1;
    if (stepNum < AppState.currentStep) {
      step.className = 'step completed';
    } else if (stepNum === AppState.currentStep) {
      step.className = 'step active';
    } else {
      step.className = 'step pending';
    }
  });
  
  document.querySelectorAll('.step-line').forEach((line, index) => {
    if (index + 1 < AppState.currentStep) {
      line.classList.add('completed');
    } else {
      line.classList.remove('completed');
    }
  });
}

// Address Input Methods
function toggleInputMethod(method) {
  const fileSection = document.getElementById('file-input-section');
  const bulkSection = document.getElementById('bulk-input-section');
  
  // Hide all sections first
  fileSection.style.display = 'none';
  bulkSection.style.display = 'none';
  
  // Show selected section
  if (method === 'file') {
    fileSection.style.display = 'block';
  } else if (method === 'bulk') {
    bulkSection.style.display = 'block';
  }
}

function addSingleAddress() {
  const input = document.getElementById('singleAddress');
  const address = input.value.trim();
  
  if (!address) {
    alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (ì£¼ì†Œëª©ë¡.includes(address)) {
    alert('ì´ë¯¸ ì¶”ê°€ëœ ì£¼ì†Œì…ë‹ˆë‹¤.');
    return;
  }
  
  ì£¼ì†Œëª©ë¡.push(address);
  saveAddressList();
  updateDataStatus();
  
  // Update UI
  updateAddedAddresses();
  input.value = '';
  
  // Show complete button
  document.getElementById('complete-btn').style.display = 'block';
}

function updateAddedAddresses() {
  const container = document.getElementById('added-addresses');
  if (!container) return;
  
  container.innerHTML = ì£¼ì†Œëª©ë¡.map((addr, index) => `
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; margin-bottom: 5px;">
      <span>${addr}</span>
      <button onclick="removeAddress(${index})" style="background: #fa709a; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">ì‚­ì œ</button>
    </div>
  `).join('');
}

function removeAddress(index) {
  ì£¼ì†Œëª©ë¡.splice(index, 1);
  saveAddressList();
  updateDataStatus();
  updateAddedAddresses();
  
  if (ì£¼ì†Œëª©ë¡.length === 0) {
    document.getElementById('complete-btn').style.display = 'none';
  }
}

function completeAddressInput() {
  if (ì£¼ì†Œëª©ë¡.length === 0) {
    alert('ìµœì†Œ í•˜ë‚˜ì˜ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  nextStep(3);
}

function updateAddressPreview() {
  const container = document.getElementById('address-preview-list');
  if (!container) return;
  
  if (ì£¼ì†Œëª©ë¡.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ë“±ë¡ëœ ì¶œì¥ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  container.innerHTML = ì£¼ì†Œëª©ë¡.map((addr, index) => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const statusClass = status === 'ì¶œì¥ì™„ë£Œ' ? 'completed' : status === 'ë¯¸ì¶œì¥' ? 'pending' : 'none';
    
    return `
      <div class="address-card ${status === 'ì¶œì¥ì™„ë£Œ' ? 'completed' : status === 'ë¯¸ì¶œì¥' ? 'pending' : ''}">
        <div class="address-title">
          <span>
            <span style="display: inline-block; width: 25px; height: 25px; background: #1b3c82; color: white; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; margin-right: 10px; font-size: 0.8rem;">
              ${index + 1}
            </span>
            ${addr}
          </span>
          <span class="address-status status-${statusClass}">${status}</span>
        </div>
      </div>
    `;
  }).join('');
}

// Travel Mode Functions
function updateTravelMode() {
  const container = document.getElementById('travel-address-list');
  if (!container) return;
  
  if (ì£¼ì†Œëª©ë¡.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ë¨¼ì € ì¤€ë¹„ëª¨ë“œì—ì„œ ì¶œì¥ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.</p>';
    return;
  }
  
  container.innerHTML = ì£¼ì†Œëª©ë¡.map((addr, index) => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const statusClass = status === 'ì¶œì¥ì™„ë£Œ' ? 'completed' : status === 'ë¯¸ì¶œì¥' ? 'pending' : 'none';
    
    return `
      <div class="address-card ${status === 'ì¶œì¥ì™„ë£Œ' ? 'completed' : status === 'ë¯¸ì¶œì¥' ? 'pending' : ''}" onclick="openAddressActions('${addr}')">
        <div class="address-title">
          <span style="font-size: 1.1rem;">
            <span style="display: inline-block; width: 30px; height: 30px; background: #1b3c82; color: white; border-radius: 50%; text-align: center; line-height: 30px; font-weight: bold; margin-right: 10px; font-size: 0.9rem;">
              ${index + 1}
            </span>
            ${addr}
          </span>
          <span class="address-status status-${statusClass}">${status}</span>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="event.stopPropagation(); openMapForAddress('${addr}')" style="flex: 1; padding: 10px;">
            ğŸ—ºï¸ ì§€ë„ ì—´ê¸°
          </button>
          <button class="btn btn-secondary" onclick="event.stopPropagation(); openRecordMode('${addr}')" style="flex: 1; padding: 10px;">
            ğŸ“ ê¸°ë¡í•˜ê¸°
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function openMapForAddress(address) {
  const baseAddr = address.replace(/\s*\([^)]*\)\s*$/, '').trim();
  const encodedAddr = encodeURIComponent(baseAddr);
  
  let appUrl = '';
  let webUrl = '';
  
  if (preferredMap === 'naver') {
    appUrl = `nmap://search?query=${encodedAddr}`;
    webUrl = `https://map.naver.com/v5/search/${encodedAddr}`;
  } else if (preferredMap === 'kakao') {
    appUrl = `kakaomap://search?q=${encodedAddr}`;
    webUrl = `https://map.kakao.com/?q=${encodedAddr}`;
  } else if (preferredMap === 'google') {
    appUrl = `comgooglemaps://?q=${encodedAddr}`;
    webUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddr}`;
  }
  
  // Try to open mobile app first, fallback to web
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (isMobile && appUrl) {
    // Create invisible iframe to test app availability
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = appUrl;
    document.body.appendChild(iframe);
    
    // Fallback to web after short delay
    setTimeout(() => {
      document.body.removeChild(iframe);
      window.open(webUrl, '_blank');
    }, 1000);
  } else {
    window.open(webUrl, '_blank');
  }
  
  // Mark as viewed
  viewedAddresses.add(address);
  saveViewedAddresses();
}

function openRecordMode(address) {
  AppState.currentAddress = address;
  selectMode('record');
  
  // Pre-fill record form
  document.getElementById('record-title').textContent = `${address} - ê¸°ë¡ ì‘ì„±`;
  document.getElementById('recordStatusSelect').value = statusMap[address] || '';
  document.getElementById('recordMemo').value = memoMap[address] || '';
  
  // Handle custom status
  const status = statusMap[address] || '';
  if (!['ì¶œì¥ì™„ë£Œ', 'ë¯¸ì¶œì¥', ''].includes(status)) {
    document.getElementById('recordStatusSelect').value = 'ì§ì ‘ì…ë ¥';
    document.getElementById('customRecordStatus').style.display = 'block';
    document.getElementById('customRecordStatus').value = status;
  }
  
  renderRecordPhotos();
}

// Record Mode Functions
function handleRecordStatusChange() {
  const select = document.getElementById('recordStatusSelect');
  const customInput = document.getElementById('customRecordStatus');
  
  if (select.value === 'ì§ì ‘ì…ë ¥') {
    customInput.style.display = 'block';
  } else {
    customInput.style.display = 'none';
  }
}

function saveRecord() {
  if (!AppState.currentAddress) return;
  
  const statusSelect = document.getElementById('recordStatusSelect');
  const customStatus = document.getElementById('customRecordStatus');
  const memo = document.getElementById('recordMemo').value.trim();
  
  let status = statusSelect.value;
  if (status === 'ì§ì ‘ì…ë ¥') {
    status = customStatus.value.trim().substring(0, 100);
  }
  
  // Save status
  if (status) {
    statusMap[AppState.currentAddress] = status;
  } else {
    delete statusMap[AppState.currentAddress];
  }
  
  // Save memo with timestamp
  if (memo) {
    const now = new Date();
    const datePrefix = now.toISOString().slice(0, 10);
    const timePrefix = now.toTimeString().slice(0, 5);
    memoMap[AppState.currentAddress] = `${datePrefix} ${timePrefix} - ${memo}`;
  } else {
    delete memoMap[AppState.currentAddress];
  }
  
  // Save to localStorage
  localStorage.setItem('statusMap', JSON.stringify(statusMap));
  localStorage.setItem('memoMap', JSON.stringify(memoMap));
  localStorage.setItem('photoMap', JSON.stringify(photoMap));
  
  alert('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  
  // Return to travel mode
  selectMode('travel');
}

// Photo handling for record mode
function saveRecordPhoto() {
  const input = document.getElementById('recordPhotoInput');
  const files = input.files;
  if (!files || !AppState.currentAddress) return;
  
  if (!Array.isArray(photoMap[AppState.currentAddress])) {
    photoMap[AppState.currentAddress] = [];
  }
  if (!Array.isArray(originalPhotoMap[AppState.currentAddress])) {
    originalPhotoMap[AppState.currentAddress] = [];
  }
  
  const urls = photoMap[AppState.currentAddress];
  if (urls.length >= 5) {
    alert('ì‚¬ì§„ì€ ìµœëŒ€ 5ì¥ê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = async e => {
      const img = new Image();
      img.onload = async () => {
        const canvas = document.createElement('canvas');
        const maxW = 800;
        const scale = maxW / img.width;
        canvas.width = maxW;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const resized = canvas.toDataURL('image/jpeg', 0.8);
        
        try {
          const uploaded = await uploadToImgur(resized);
          if (uploaded) {
            photoMap[AppState.currentAddress].push(uploaded);
            originalPhotoMap[AppState.currentAddress].push(uploaded);
            localStorage.setItem('photoMap', JSON.stringify(photoMap));
            renderRecordPhotos();
          }
        } catch (error) {
          alert('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
  
  setTimeout(() => {
    input.value = '';
  }, 500);
}

function renderRecordPhotos() {
  const container = document.getElementById('recordPhotoContainer');
  if (!container || !AppState.currentAddress) return;
  
  container.innerHTML = '';
  const photos = Array.isArray(photoMap[AppState.currentAddress]) ? photoMap[AppState.currentAddress] : [];
  
  photos.forEach((url, i) => {
    const img = document.createElement('img');
    img.src = url;
    img.className = 'photo-preview';
    img.onclick = () => handleRecordPhotoClick(i);
    container.appendChild(img);
  });
}

function handleRecordPhotoClick(index) {
  const imgUrl = originalPhotoMap[AppState.currentAddress]?.[index];
  if (!imgUrl) return;
  
  const dialog = document.createElement('div');
  dialog.style.cssText = `
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 20px; border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999;
  `;
  dialog.innerHTML = `
    <p style="margin-bottom: 15px; text-align: center; font-weight: 600;">ì‚¬ì§„ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button id="viewBtn" class="btn btn-primary">ğŸ“· í¬ê²Œ ë³´ê¸°</button>
      <button id="deleteBtn" class="btn btn-danger">âŒ ì‚­ì œ</button>
      <button id="cancelBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
    </div>
  `;
  document.body.appendChild(dialog);
  
  document.getElementById('viewBtn').onclick = () => {
    const popup = window.open('', '_blank');
    popup.document.write(`<img src='${imgUrl}' style='max-width:100%; height:auto;'>`);
    document.body.removeChild(dialog);
  };
  document.getElementById('deleteBtn').onclick = () => {
    deleteRecordPhoto(index);
    document.body.removeChild(dialog);
  };
  document.getElementById('cancelBtn').onclick = () => {
    document.body.removeChild(dialog);
  };
}

function deleteRecordPhoto(index) {
  if (!AppState.currentAddress || !photoMap[AppState.currentAddress]) return;
  photoMap[AppState.currentAddress].splice(index, 1);
  localStorage.setItem('photoMap', JSON.stringify(photoMap));
  renderRecordPhotos();
}
  
// Summary Mode Functions
function updateSummaryMode() {
  updateTable();
  drawChart();
}

function updateTable() {
  const tbody = document.getElementById('tableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  ì£¼ì†Œëª©ë¡.forEach((addr, index) => {
    const rawStatus = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const classStatus = ['ì¶œì¥ì™„ë£Œ', 'ë¯¸ì¶œì¥', 'ë¯¸ì„ íƒ'].includes(rawStatus) ? rawStatus : 'ì§ì ‘ì…ë ¥';
    const memo = memoMap[addr] || '-';
    const photos = Array.isArray(photoMap[addr]) ? photoMap[addr] : [];
    const photoCount = photos.length > 0 ? `ğŸ“· ${photos.length}ì¥` : '-';
    
    const row = document.createElement('tr');
    row.style.cssText = getStatusRowStyle(classStatus);
    row.innerHTML = `
      <td style="padding: 15px; border-bottom: 1px solid #e1e5e9; text-align: center;">
        <span style="display: inline-block; width: 25px; height: 25px; background: #1b3c82; color: white; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; font-size: 0.8rem;">
          ${index + 1}
        </span>
      </td>
      <td style="padding: 15px; border-bottom: 1px solid #e1e5e9;">${addr}</td>
      <td style="padding: 15px; border-bottom: 1px solid #e1e5e9;">${rawStatus}</td>
      <td style="padding: 15px; border-bottom: 1px solid #e1e5e9; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${memo}">${memo}</td>
      <td style="padding: 15px; border-bottom: 1px solid #e1e5e9;">${photoCount}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Update summary
  const summary = document.getElementById('tableSummary');
  if (summary) {
    summary.textContent = `ì´ ${ì£¼ì†Œëª©ë¡.length}ê±´`;
  }
}

function getStatusRowStyle(status) {
  switch(status) {
    case 'ì¶œì¥ì™„ë£Œ': return 'background-color: rgba(76, 175, 80, 0.1);';
    case 'ë¯¸ì¶œì¥': return 'background-color: rgba(244, 67, 54, 0.1);';
    case 'ë¯¸ì„ íƒ': return 'background-color: rgba(158, 158, 158, 0.1);';
    default: return 'background-color: rgba(255, 193, 7, 0.1);';
  }
}

function drawChart() {
  const ctx = document.getElementById('statusChart');
  if (!ctx) return;
  
  const count = { ì¶œì¥ì™„ë£Œ: 0, ë¯¸ì¶œì¥: 0, ë¯¸ì„ íƒ: 0, ì§ì ‘ì…ë ¥: 0 };
  ì£¼ì†Œëª©ë¡.forEach(addr => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const key = ['ì¶œì¥ì™„ë£Œ', 'ë¯¸ì¶œì¥', 'ë¯¸ì„ íƒ'].includes(status) ? status : 'ì§ì ‘ì…ë ¥';
    count[key]++;
  });
  
  const data = {
    labels: Object.keys(count),
    datasets: [{
      label: 'ìƒíƒœë³„ ê°œìˆ˜',
      data: Object.values(count),
      backgroundColor: ['#4caf50', '#f44336', '#90a4ae', '#ffcc80'],
      borderRadius: 8,
      borderWidth: 0
    }]
  };
  
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx.getContext('2d'), {
    type: 'bar',
    data: data,
    options: { 
      responsive: true, 
      plugins: { 
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: 'white',
          bodyColor: 'white',
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1,
          cornerRadius: 8
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
  
  const total = Object.values(count).reduce((a, b) => a + b, 0);
  const statsCount = document.getElementById('statsCount');
  const chartText = document.getElementById('chartTextOutput');
  
  if (statsCount) {
    statsCount.textContent = `ì´ í•­ëª© ìˆ˜: ${total}ê±´`;
  }
  if (chartText) {
    chartText.textContent = Object.entries(count).map(([k,v]) => `${k}: ${v}ê±´`).join(' / ');
  }
}

function copyTable() {
  let text = 'ìˆœì„œ\tì£¼ì†Œ\tìƒíƒœ\të©”ëª¨\tì‚¬ì§„ê°œìˆ˜\n';
  ì£¼ì†Œëª©ë¡.forEach((addr, index) => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const memo = (memoMap[addr] || '').replace(/\n/g, ' ');
    const photoCount = Array.isArray(photoMap[addr]) ? photoMap[addr].length : 0;
    text += (index + 1) + '\t' + addr + '\t' + status + '\t' + memo + '\t' + photoCount + '\n';
  });
  navigator.clipboard.writeText(text).then(() => alert('ë³µì‚¬ ì™„ë£Œ'));
}

function exportText() {
  let content = 'ì¶œì¥ ê¸°ë¡ - í…ìŠ¤íŠ¸ ë²„ì „\n';
  content += '='.repeat(50) + '\n\n';
  
  ì£¼ì†Œëª©ë¡.forEach((addr, index) => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const memo = memoMap[addr] || 'ê¸°ë¡ ì—†ìŒ';
    const photoCount = Array.isArray(photoMap[addr]) ? photoMap[addr].length : 0;
    
    content += `${index + 1}. ${addr}\n`;
    content += `   ìƒíƒœ: ${status}\n`;
    content += `   ë©”ëª¨: ${memo}\n`;
    content += `   ì‚¬ì§„: ${photoCount}ì¥\n`;
    content += '-'.repeat(30) + '\n';
  });
  
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'ì¶œì¥ê¸°ë¡.txt';
  link.click();
}

function exportExcel() {
  const wb = XLSX.utils.book_new();
  const data = [['ìˆœì„œ', 'ì£¼ì†Œ', 'ìƒíƒœ', 'ë©”ëª¨', 'ì‚¬ì§„1', 'ì‚¬ì§„2', 'ì‚¬ì§„3', 'ì‚¬ì§„4', 'ì‚¬ì§„5']];
  ì£¼ì†Œëª©ë¡.forEach((addr, index) => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const memo = memoMap[addr] || '';
    const photos = Array.isArray(photoMap[addr]) ? photoMap[addr] : [];
    const limitedMemo = memo.length > 10000 ? memo.slice(0, 10000) + '...' : memo;
    const row = [index + 1, addr, status, limitedMemo, ...photos.slice(0, 5)];
    while (row.length < 9) row.push('');
    data.push(row);
  });
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // ì‚¬ì§„ ë§í¬ ì…€ì— í•˜ì´í¼ë§í¬ ì¶”ê°€
  data.forEach((row, rowIndex) => {
    if (rowIndex === 0) return;
    for (let i = 4; i <= 8; i++) {
      const cellAddr = XLSX.utils.encode_cell({ r: rowIndex, c: i });
      const val = row[i];
      if (val && typeof val === 'string') {
        ws[cellAddr].l = { Target: val };
      }
    }
  });
  
  XLSX.utils.book_append_sheet(wb, ws, 'ì¶œì¥ê¸°ë¡');
  XLSX.writeFile(wb, 'ì¶œì¥ê¸°ë¡.xlsx');
}

  
  // Utility Functions
function saveMapPreference() {
  preferredMap = document.getElementById('mapSelect').value;
  if (document.getElementById('rememberMap') && document.getElementById('rememberMap').checked) {
    localStorage.setItem('preferredMap', preferredMap);
  }
}

function saveAddressList() {
  localStorage.setItem('addressList', JSON.stringify(ì£¼ì†Œëª©ë¡));
}

function saveViewedAddresses() {
  localStorage.setItem('viewedAddresses', JSON.stringify([...viewedAddresses]));
}

function resetAddressList() {
  if (!confirm('ëª¨ë“  ì£¼ì†Œ ëª©ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  ì£¼ì†Œëª©ë¡ = [];
  AppState.currentAddress = null;
  saveAddressList();
  updateAddressPreview();
  updateTravelMode();
  alert('ì£¼ì†Œ ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function resetStatusMap() {
  if (!confirm('ëª¨ë“  ìƒíƒœ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  statusMap = {};
  localStorage.removeItem('statusMap');
  alert('ìƒíƒœ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// File handling functions
function loadAddressFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split(/\r?\n/).filter(line => line.trim());
    const newList = [];
    let added = 0;
    
    lines.forEach(line => {
      const [addr, status] = line.split('\t');
      const trimmedAddr = addr?.trim();
      if (trimmedAddr && !ì£¼ì†Œëª©ë¡.includes(trimmedAddr)) {
        newList.push(trimmedAddr);
        if (status) statusMap[trimmedAddr] = status.trim();
        added++;
      } else if (trimmedAddr && status) {
        statusMap[trimmedAddr] = status.trim();
      }
    });
    
    ì£¼ì†Œëª©ë¡ = [...ì£¼ì†Œëª©ë¡, ...newList];
    alert(`ì£¼ì†Œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ${lines.length}ê±´ ì¤‘ ${added}ê±´ ì¶”ê°€ë¨ (ì´ ${ì£¼ì†Œëª©ë¡.length}ê±´)`);
    
    saveAddressList();
    localStorage.setItem('statusMap', JSON.stringify(statusMap));
    nextStep(3);
  };
  
  reader.readAsText(file, 'UTF-8');
}

function addFromTextarea() {
  const input = document.getElementById('bulkPaste').value;
  if (!input) {
    alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const lines = input.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const newList = lines.filter(l => !ì£¼ì†Œëª©ë¡.includes(l));
  ì£¼ì†Œëª©ë¡ = [...ì£¼ì†Œëª©ë¡, ...newList];
  saveAddressList();
  
  alert(`${newList.length}ê°œì˜ ì£¼ì†Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  document.getElementById('bulkPaste').value = '';
  nextStep(3);
}

// Imgur upload function
function uploadToImgur(base64Image) {
  return fetch('https://api.imgur.com/3/image', {
    method: 'POST',
    headers: {
      Authorization: 'Client-ID a0058fd0a6e3657',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      image: base64Image.split(',')[1],
      type: 'base64'
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success && data.data && data.data.link) {
      return data.data.link;
    } else {
      throw new Error('Imgur ì—…ë¡œë“œ ì‹¤íŒ¨');
    }
  });
}

// Optimal Route Variables
const GEMINI_API_KEY = 'AIzaSyB39d0FJHlO8NzvQaowq9zHNyE1uKgSrJQ';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';

// Debug Log System
let debugLogs = [];
function addDebugLog(message, data = null) {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    message,
    data: data ? JSON.stringify(data, null, 2) : null
  };
  debugLogs.push(logEntry);
  console.log(`[DEBUG ${timestamp}] ${message}`, data);
  
  // Keep only last 100 logs
  if (debugLogs.length > 100) {
    debugLogs = debugLogs.slice(-100);
  }
}

function downloadDebugLogs() {
  const logContent = debugLogs.map(log => {
    let entry = `[${log.timestamp}] ${log.message}`;
    if (log.data) {
      entry += `\n${log.data}`;
    }
    return entry;
  }).join('\n\n' + '='.repeat(50) + '\n\n');
  
  const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `debug_log_${new Date().toISOString().slice(0,19).replace(/[:.]/g, '-')}.txt`;
  link.click();
}

// Optimal Route Functions
function showOptimalRouteModal() {
  if (ì£¼ì†Œëª©ë¡.length < 2) {
    alert('ìµœì ê²½ë¡œ ì¶”ì²œì„ ìœ„í•´ì„œëŠ” ìµœì†Œ 2ê³³ ì´ìƒì˜ ì¶œì¥ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  // Update address count and preview
  document.getElementById('route-address-count').textContent = ì£¼ì†Œëª©ë¡.length;
  const preview = document.getElementById('route-address-preview');
  preview.innerHTML = ì£¼ì†Œëª©ë¡.slice(0, 5).map(addr => `â€¢ ${addr}`).join('<br>') + 
    (ì£¼ì†Œëª©ë¡.length > 5 ? `<br>â€¢ ... ì™¸ ${ì£¼ì†Œëª©ë¡.length - 5}ê³³` : '');
  
  document.getElementById('optimalRouteModal').classList.add('show');
}

async function calculateOptimalRoute() {
  addDebugLog('=== ìµœì ê²½ë¡œ ê³„ì‚° ì‹œì‘ ===');
  
  const startLocation = document.getElementById('startLocation').value.trim();
  addDebugLog('ì¶œë°œì§€ ì…ë ¥ê°’', { startLocation });
  addDebugLog('í˜„ì¬ ì£¼ì†Œëª©ë¡', { addresses: ì£¼ì†Œëª©ë¡, count: ì£¼ì†Œëª©ë¡.length });
  
  if (!startLocation) {
    addDebugLog('ì˜¤ë¥˜: ì¶œë°œì§€ê°€ ë¹„ì–´ìˆìŒ');
    alert('ì¶œë°œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (ì£¼ì†Œëª©ë¡.length < 2) {
    addDebugLog('ì˜¤ë¥˜: ì£¼ì†Œê°€ 2ê°œ ë¯¸ë§Œ', { count: ì£¼ì†Œëª©ë¡.length });
    alert('ê²½ë¡œ ìµœì í™”ë¥¼ ìœ„í•´ì„œëŠ” ìµœì†Œ 2ê³³ ì´ìƒì˜ ì¶œì¥ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  // Show loading
  addDebugLog('ë¡œë”© UI í‘œì‹œ');
  document.getElementById('route-loading').style.display = 'block';
  document.getElementById('calculate-route-btn').disabled = true;
  document.getElementById('calculate-route-btn').textContent = 'ê³„ì‚°ì¤‘...';
  
  try {
    addDebugLog('Gemini API í˜¸ì¶œ ì‹œì‘', { startLocation, destinationCount: ì£¼ì†Œëª©ë¡.length });
    const optimalOrder = await getOptimalRouteFromGemini(startLocation, ì£¼ì†Œëª©ë¡);
    addDebugLog('Gemini API ì‘ë‹µ ë°›ìŒ', { optimalOrder });
    
    if (optimalOrder && optimalOrder.length > 0) {
      addDebugLog('ìµœì  ìˆœì„œ ì ìš© ì‹œì‘', { originalOrder: ì£¼ì†Œëª©ë¡, optimalOrder });
      
      // Reorder the address list based on optimal route
      const newOrder = [];
      optimalOrder.forEach((index, i) => {
        addDebugLog(`ìˆœì„œ ${i}: ì¸ë±ìŠ¤ ${index} ì²˜ë¦¬ ì¤‘`);
        if (index >= 0 && index < ì£¼ì†Œëª©ë¡.length) {
          newOrder.push(ì£¼ì†Œëª©ë¡[index]);
          addDebugLog(`ì¶”ê°€ë¨: ${ì£¼ì†Œëª©ë¡[index]}`);
        } else {
          addDebugLog(`ê²½ê³ : ì˜ëª»ëœ ì¸ë±ìŠ¤ ${index} (ë²”ìœ„: 0-${ì£¼ì†Œëª©ë¡.length-1})`);
        }
      });
      
      // Add any missing addresses
      ì£¼ì†Œëª©ë¡.forEach(addr => {
        if (!newOrder.includes(addr)) {
          addDebugLog(`ëˆ„ë½ëœ ì£¼ì†Œ ì¶”ê°€: ${addr}`);
          newOrder.push(addr);
        }
      });
      
      addDebugLog('ìµœì¢… ìƒˆ ìˆœì„œ', { newOrder });
      ì£¼ì†Œëª©ë¡ = newOrder;
      saveAddressList();
      addDebugLog('ì£¼ì†Œëª©ë¡ ì €ì¥ ì™„ë£Œ');
      
      // Update UI
      updateTravelMode();
      updateAddressPreview();
      addDebugLog('UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      
      closeModal();
      alert('âœ… ìµœì ê²½ë¡œë¡œ ì¶œì¥ì§€ ìˆœì„œê°€ ì¬ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      addDebugLog('=== ìµœì ê²½ë¡œ ê³„ì‚° ì„±ê³µ ì™„ë£Œ ===');
    } else {
      addDebugLog('ì˜¤ë¥˜: ë¹ˆ ìµœì ìˆœì„œ ê²°ê³¼', { optimalOrder });
      throw new Error('ê²½ë¡œ ìµœì í™” ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    addDebugLog('ìµœì ê²½ë¡œ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ ë°œìƒ', { 
      error: error.message, 
      stack: error.stack,
      name: error.name
    });
    console.error('Optimal route calculation failed:', error);
    
    // Try fallback simple algorithm
    addDebugLog('Fallback ì•Œê³ ë¦¬ì¦˜ ì‹œë„');
    try {
      const simpleOrder = getSimpleFallbackOrder(ì£¼ì†Œëª©ë¡);
      addDebugLog('Fallback ì•Œê³ ë¦¬ì¦˜ ê²°ê³¼', { simpleOrder });
      
      if (simpleOrder && simpleOrder.length > 0) {
        const newOrder = [];
        simpleOrder.forEach(index => {
          if (index >= 0 && index < ì£¼ì†Œëª©ë¡.length) {
            newOrder.push(ì£¼ì†Œëª©ë¡[index]);
          }
        });
        
        ì£¼ì†Œëª©ë¡ = newOrder.length > 0 ? newOrder : ì£¼ì†Œëª©ë¡;
        saveAddressList();
        updateTravelMode();
        updateAddressPreview();
        closeModal();
        
        alert('âš ï¸ AI ìµœì ê²½ë¡œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, ê°„ë‹¨í•œ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìˆœì„œë¥¼ ì¬ì •ë ¬í–ˆìŠµë‹ˆë‹¤.');
        addDebugLog('Fallback ì•Œê³ ë¦¬ì¦˜ ì„±ê³µ');
        return; // Exit early on fallback success
      }
    } catch (fallbackError) {
      addDebugLog('Fallback ì•Œê³ ë¦¬ì¦˜ë„ ì‹¤íŒ¨', { error: fallbackError.message });
    }
    
    // Download debug logs automatically on error
    setTimeout(() => {
      if (confirm('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë””ë²„ê·¸ ë¡œê·¸ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        downloadDebugLogs();
      }
    }, 500);
    
    alert('âŒ ìµœì ê²½ë¡œ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\nì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  } finally {
    // Hide loading
    addDebugLog('ë¡œë”© UI ìˆ¨ê¹€');
    document.getElementById('route-loading').style.display = 'none';
    document.getElementById('calculate-route-btn').disabled = false;
    document.getElementById('calculate-route-btn').textContent = 'ğŸ¤– AI ìµœì ê²½ë¡œ ê³„ì‚°í•˜ê¸°';
  }
}

async function getOptimalRouteFromGemini(startLocation, destinations) {
  addDebugLog('Gemini API í•¨ìˆ˜ ì‹œì‘', { startLocation, destinations });
  
  const prompt = `ì°¨ëŸ‰ ê²½ë¡œ ìµœì í™” ì„ë¬´
ë‹¹ì‹ ì€ ì°¨ëŸ‰ ì´ë™ ê²½ë¡œë¥¼ ìµœì í™”í•˜ëŠ” ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ **[ì…ë ¥]**ì— ì£¼ì–´ì§„ ëª¨ë“  ëª©ì ì§€ë¥¼ ë°©ë¬¸í•˜ëŠ” ìµœì ì˜ ìˆœì„œë¥¼ ê³„ì‚°í•˜ì„¸ìš”.

[ì…ë ¥]

ì¶œë°œì§€: ${startLocation}

ëª©ì ì§€:
${destinations.map((addr, i) => `${i}. ${addr}`).join('\n')}

[ìµœì í™” ëª©í‘œ]
ëª¨ë“  ëª©ì ì§€ë¥¼ ì •í™•íˆ 1íšŒì”© ë°©ë¬¸í•˜ë©° **'ì´ ì°¨ëŸ‰ ì´ë™ ì†Œìš”ì‹œê°„(êµí†µ ìƒí™© ë°˜ì˜)'**ì„ ìµœì†Œí™”í•˜ëŠ” ê²½ë¡œë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.

[ê³„ì‚° ì›ì¹™]

ìµœìš°ì„ í•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…, ì£¼ì„, ê°œí–‰, ê³µë°±ì€ ì¼ì ˆ í¬í•¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì¶œë ¥ ì˜ˆì‹œ: [2,0,3,1,...]`;

  addDebugLog('ìƒì„±ëœ í”„ë¡¬í”„íŠ¸', { prompt });

  const requestBody = {
    contents: [{
      parts: [{
        text: prompt
      }]
    }]
  };

  addDebugLog('API ìš”ì²­ ë°”ë””', { requestBody });
  addDebugLog('API URL ë° í‚¤ ì •ë³´', { 
    url: `${GEMINI_API_URL}?key=${GEMINI_API_KEY.substring(0, 10)}...`,
    keyLength: GEMINI_API_KEY.length 
  });

  try {
    addDebugLog('fetch ìš”ì²­ ì‹œì‘');
    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(requestBody),
      mode: 'cors'
    });

    addDebugLog('fetch ì‘ë‹µ ë°›ìŒ', { 
      status: response.status, 
      statusText: response.statusText,
      ok: response.ok,
      headers: Object.fromEntries(response.headers.entries())
    });

    if (!response.ok) {
      const errorText = await response.text();
      addDebugLog('API ìš”ì²­ ì‹¤íŒ¨ - ì‘ë‹µ ë‚´ìš©', { status: response.status, errorText });
      throw new Error(`API request failed: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    addDebugLog('API ì‘ë‹µ JSON íŒŒì‹± ì™„ë£Œ', { data });
    
    // Handle both old and new API response structures
    let text = '';
    if (data.candidates && data.candidates[0]) {
      if (data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
        // New API structure
        text = data.candidates[0].content.parts[0].text.trim();
        addDebugLog('ìƒˆ API êµ¬ì¡°ë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ', { text });
      } else if (data.candidates[0].parts && data.candidates[0].parts[0]) {
        // Old API structure
        text = data.candidates[0].parts[0].text.trim();
        addDebugLog('êµ¬ API êµ¬ì¡°ë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ', { text });
      } else {
        addDebugLog('API ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜', { data });
        throw new Error('Invalid API response structure - no text found');
      }
    } else {
      addDebugLog('API ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜ - candidates ì—†ìŒ', { data });
      throw new Error('Invalid API response structure - no candidates');
    }
    addDebugLog('ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ì‘ë‹µ', { text });
    
    try {
      // Remove any markdown code block formatting
      let cleanText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      addDebugLog('ì •ë¦¬ëœ í…ìŠ¤íŠ¸', { cleanText });
      
      // Extract JSON array from response
      const match = cleanText.match(/\[[\d,\s]+\]/);
      addDebugLog('ì •ê·œì‹ ë§¤ì¹­ ê²°ê³¼', { match, originalText: text, cleanText });
      
      if (match) {
        const optimalOrder = JSON.parse(match[0]);
        addDebugLog('íŒŒì‹±ëœ ìµœì  ìˆœì„œ', { optimalOrder });
        
        // Validate the result
        if (!Array.isArray(optimalOrder)) {
          throw new Error('Result is not an array');
        }
        
        if (optimalOrder.length === 0) {
          throw new Error('Empty result array');
        }
        
        // Check if all indices are valid
        const invalidIndices = optimalOrder.filter(idx => 
          typeof idx !== 'number' || idx < 0 || idx >= destinations.length
        );
        
        if (invalidIndices.length > 0) {
          addDebugLog('ì˜ëª»ëœ ì¸ë±ìŠ¤ ë°œê²¬', { invalidIndices, validRange: `0-${destinations.length-1}` });
        }
        
        return optimalOrder;
      } else {
        addDebugLog('JSON ë°°ì—´ íŒ¨í„´ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', { text });
        throw new Error('Invalid response format - no JSON array found');
      }
    } catch (parseError) {
      addDebugLog('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜', { 
        error: parseError.message, 
        rawText: text 
      });
      throw parseError;
    }
  } catch (fetchError) {
    addDebugLog('Fetch ì˜¤ë¥˜', { 
      error: fetchError.message, 
      stack: fetchError.stack 
    });
    throw fetchError;
  }
}

// Simple fallback route optimization algorithm
function getSimpleFallbackOrder(destinations) {
  addDebugLog('ê°„ë‹¨í•œ fallback ì•Œê³ ë¦¬ì¦˜ ì‹œì‘', { destinations });
  
  if (!destinations || destinations.length === 0) {
    return [];
  }
  
  if (destinations.length === 1) {
    return [0];
  }
  
  // Simple strategy: try to group similar addresses by area/district
  const result = [];
  const used = new Set();
  
  // Start with first address
  result.push(0);
  used.add(0);
  
  // Greedy approach: find addresses that seem "closest" by text similarity
  while (result.length < destinations.length) {
    let bestMatch = -1;
    let bestScore = -1;
    
    const lastAddr = destinations[result[result.length - 1]];
    
    for (let i = 0; i < destinations.length; i++) {
      if (used.has(i)) continue;
      
      const currentAddr = destinations[i];
      const score = calculateAddressSimilarity(lastAddr, currentAddr);
      
      if (score > bestScore) {
        bestScore = score;
        bestMatch = i;
      }
    }
    
    if (bestMatch !== -1) {
      result.push(bestMatch);
      used.add(bestMatch);
    } else {
      // Add any remaining addresses
      for (let i = 0; i < destinations.length; i++) {
        if (!used.has(i)) {
          result.push(i);
          used.add(i);
          break;
        }
      }
    }
  }
  
  addDebugLog('Fallback ì•Œê³ ë¦¬ì¦˜ ì™„ë£Œ', { result });
  return result;
}

function calculateAddressSimilarity(addr1, addr2) {
  // Enhanced similarity for Gwangjin-gu addresses
  const words1 = addr1.replace(/\d+/g, '').split(/\s+/).filter(w => w.length > 0);
  const words2 = addr2.replace(/\d+/g, '').split(/\s+/).filter(w => w.length > 0);
  
  let commonWords = 0;
  let regionScore = 0;
  
  // Basic word matching
  for (const word1 of words1) {
    if (words2.some(word2 => word2.includes(word1) || word1.includes(word2))) {
      commonWords++;
    }
  }
  
  // Regional clustering for Gwangjin-gu
  const regions = {
    western: ['êµ¬ì˜', 'ìì–‘'],           // ì„œì¸¡
    northern: ['ëŠ¥ë™', 'ì¤‘ê³¡'],          // ë¶ì¸¡  
    riverside: ['ëšì„¬', 'í•œê°•', 'ê°•ë³€'], // í•œê°•ë³€
    central: ['ì•„ì°¨ì‚°', 'ë™ì¼']          // ì¤‘ì•™ê°„ì„ 
  };
  
  const getRegion = (addr) => {
    for (const [region, keywords] of Object.entries(regions)) {
      if (keywords.some(keyword => addr.includes(keyword))) {
        return region;
      }
    }
    return 'unknown';
  };
  
  const region1 = getRegion(addr1);
  const region2 = getRegion(addr2);
  
  // Same region gets higher score
  if (region1 === region2 && region1 !== 'unknown') {
    regionScore = 2;
  } else if (region1 !== 'unknown' && region2 !== 'unknown') {
    // Adjacent regions get moderate score
    const adjacency = {
      western: ['northern', 'riverside'],
      northern: ['western', 'central'],
      riverside: ['western', 'central'],
      central: ['northern', 'riverside']
    };
    if (adjacency[region1]?.includes(region2)) {
      regionScore = 1;
    }
  }
  
  return (commonWords + regionScore) / Math.max(words1.length, words2.length, 3);
}

// Route Algorithm Comparison
async function compareRouteAlgorithms() {
  if (ì£¼ì†Œëª©ë¡.length < 2) {
    alert('ê²½ë¡œ ë¹„êµë¥¼ ìœ„í•´ì„œëŠ” ìµœì†Œ 2ê³³ ì´ìƒì˜ ì¶œì¥ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  const startLocation = document.getElementById('startLocation').value.trim() || 'ì•„ì°¨ì‚°ë¡œ 400';
  
  addDebugLog('=== ì•Œê³ ë¦¬ì¦˜ ë¹„êµ ì‹œì‘ ===', { startLocation, addresses: ì£¼ì†Œëª©ë¡ });

  // Show loading
  document.getElementById('route-loading').style.display = 'block';
  
  const results = {};
  
  try {
    // 1. AI ìµœì í™” ê²°ê³¼
    try {
      const aiResult = await getOptimalRouteFromGemini(startLocation, ì£¼ì†Œëª©ë¡);
      results.ai = aiResult;
      addDebugLog('AI ì•Œê³ ë¦¬ì¦˜ ê²°ê³¼', { result: aiResult });
    } catch (error) {
      results.ai = null;
      addDebugLog('AI ì•Œê³ ë¦¬ì¦˜ ì‹¤íŒ¨', { error: error.message });
    }

    // 2. ì§€ì—­ ê¸°ë°˜ Fallback ê²°ê³¼
    const fallbackResult = getSimpleFallbackOrder(ì£¼ì†Œëª©ë¡);
    results.fallback = fallbackResult;
    addDebugLog('Fallback ì•Œê³ ë¦¬ì¦˜ ê²°ê³¼', { result: fallbackResult });

    // 3. í˜„ì¬ ìˆœì„œ
    results.current = Array.from({ length: ì£¼ì†Œëª©ë¡.length }, (_, i) => i);

    // ê²°ê³¼ í‘œì‹œ
    showRouteComparison(results, startLocation);

  } catch (error) {
    addDebugLog('ì•Œê³ ë¦¬ì¦˜ ë¹„êµ ì¤‘ ì˜¤ë¥˜', { error: error.message });
    alert('ì•Œê³ ë¦¬ì¦˜ ë¹„êµ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  } finally {
    document.getElementById('route-loading').style.display = 'none';
  }
}


function showRouteComparison(results, startLocation) {
  let comparisonHTML = `
    <div style="max-width: 600px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
      <h3 style="text-align: center; color: #1b3c82; margin-bottom: 25px;">ğŸ” ê²½ë¡œ ì•Œê³ ë¦¬ì¦˜ ë¹„êµ</h3>
      <p style="text-align: center; color: #666; margin-bottom: 20px;">ì¶œë°œì§€: ${startLocation}</p>
  `;

  const algorithms = [
    { key: 'ai', name: 'ğŸ¤– Gemini ATSP', color: '#2196F3' },
    { key: 'fallback', name: 'ğŸ“ ì§€ì—­ ê¸°ë°˜', color: '#FF9800' },
    { key: 'current', name: 'ğŸ“‹ í˜„ì¬ ìˆœì„œ', color: '#9E9E9E' }
  ];

  algorithms.forEach(alg => {
    if (results[alg.key]) {
      const route = results[alg.key].map(i => ì£¼ì†Œëª©ë¡[i]);
      comparisonHTML += `
        <div style="margin-bottom: 20px; padding: 15px; border-left: 4px solid ${alg.color}; background: rgba(0,0,0,0.02);">
          <div style="font-weight: 600; color: ${alg.color}; margin-bottom: 8px;">${alg.name}</div>
          <div style="font-size: 0.9rem; line-height: 1.4;">
            ${route.map((addr, idx) => `${idx + 1}. ${addr}`).join('<br>')}
          </div>
          <button onclick="applyRoute([${results[alg.key].join(',')}], '${alg.name}')" 
                  style="margin-top: 10px; padding: 5px 15px; background: ${alg.color}; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
            ì´ ê²½ë¡œ ì ìš©
          </button>
        </div>
      `;
    }
  });

  comparisonHTML += `
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="closeComparisonModal()" class="btn btn-secondary">ë‹«ê¸°</button>
      </div>
    </div>
  `;

  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.id = 'comparisonModal';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
    z-index: 10000; backdrop-filter: blur(5px);
  `;
  overlay.innerHTML = comparisonHTML;
  document.body.appendChild(overlay);
}

function applyRoute(routeOrder, algorithmName) {
  addDebugLog('ê²½ë¡œ ì ìš©', { routeOrder, algorithmName });
  
  const newOrder = [];
  routeOrder.forEach(index => {
    if (index >= 0 && index < ì£¼ì†Œëª©ë¡.length) {
      newOrder.push(ì£¼ì†Œëª©ë¡[index]);
    }
  });
  
  ì£¼ì†Œëª©ë¡ = newOrder;
  saveAddressList();
  updateTravelMode();
  updateAddressPreview();
  
  closeComparisonModal();
  closeModal();
  
  alert(`âœ… ${algorithmName} ê²½ë¡œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

function closeComparisonModal() {
  const modal = document.getElementById('comparisonModal');
  if (modal) {
    document.body.removeChild(modal);
  }
}

function showManualRouteEditor() {
  alert('ğŸš§ ìˆ˜ë™ í¸ì§‘ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.\n\ní˜„ì¬ëŠ” ì•Œê³ ë¦¬ì¦˜ ë¹„êµì—ì„œ ì›í•˜ëŠ” ê²½ë¡œë¥¼ ì„ íƒí•´ ì‚¬ìš©í•˜ì„¸ìš”.');
}

// API Connection Test
async function testAPIConnection() {
  addDebugLog('=== API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  // First, try to list available models
  try {
    addDebugLog('ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ ìš”ì²­ ì‹œì‘');
    const listModelsUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`;
    const listResponse = await fetch(listModelsUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      },
      mode: 'cors'
    });
    
    if (listResponse.ok) {
      const listData = await listResponse.json();
      addDebugLog('ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡', { models: listData.models?.slice(0, 10) }); // Only log first 10
      
      // Find a suitable model for generateContent
      const suitableModel = listData.models?.find(model => 
        model.name.includes('gemini') && 
        model.supportedGenerationMethods?.includes('generateContent')
      );
      
      if (suitableModel) {
        addDebugLog('ì í•©í•œ ëª¨ë¸ ë°œê²¬', { modelName: suitableModel.name });
        // Update the API URL with the found model
        const modelName = suitableModel.name.replace('models/', '');
        const newUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent`;
        addDebugLog('ìƒˆ API URL ìƒì„±', { newUrl, originalUrl: GEMINI_API_URL });
        
        // Test with the found model
        const testResult = await testWithSpecificModel(newUrl);
        return testResult;
      }
    }
  } catch (listError) {
    addDebugLog('ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨', { error: listError.message });
  }
  
  // If model listing fails, try with current URL
  addDebugLog('ê¸°ë³¸ ëª¨ë¸ë¡œ í…ŒìŠ¤íŠ¸ ì‹œë„', { url: GEMINI_API_URL });
  return await testWithSpecificModel(GEMINI_API_URL);
}

async function testWithSpecificModel(apiUrl) {
  const testRequestBody = {
    contents: [{
      parts: [{
        text: "Hello! Please respond with just the number: 123"
      }]
    }]
  };
  
  try {
    addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ API ìš”ì²­ ì‹œì‘', { apiUrl, testRequestBody });
    
    const response = await fetch(`${apiUrl}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(testRequestBody),
      mode: 'cors'
    });
    
    addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‘ë‹µ ë°›ìŒ', { 
      status: response.status, 
      statusText: response.statusText,
      ok: response.ok 
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ API ìš”ì²­ ì‹¤íŒ¨', { status: response.status, errorText });
      alert(`âŒ API ì—°ê²° ì‹¤íŒ¨!\nëª¨ë¸: ${apiUrl}\nìƒíƒœ: ${response.status}\nì˜¤ë¥˜: ${errorText}`);
      return false;
    }
    
    const data = await response.json();
    addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‘ë‹µ ë°ì´í„°', { data });
    
    // Handle both old and new API response structures for test
    let responseText = '';
    if (data.candidates && data.candidates[0]) {
      if (data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
        // New API structure
        responseText = data.candidates[0].content.parts[0].text;
        addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‘ë‹µ í…ìŠ¤íŠ¸ (ìƒˆ êµ¬ì¡°)', { responseText });
      } else if (data.candidates[0].parts && data.candidates[0].parts[0]) {
        // Old API structure
        responseText = data.candidates[0].parts[0].text;
        addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‘ë‹µ í…ìŠ¤íŠ¸ (êµ¬ êµ¬ì¡°)', { responseText });
      } else {
        addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜', { data });
        alert('âš ï¸ APIëŠ” ì—°ê²°ë˜ì—ˆì§€ë§Œ ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.');
        return false;
      }
      
      alert(`âœ… API ì—°ê²° ì„±ê³µ!\nëª¨ë¸: ${apiUrl}\nì‘ë‹µ: ${responseText}`);
      
      // Update global URL if this works and it's different
      if (apiUrl !== GEMINI_API_URL) {
        addDebugLog('ì „ì—­ API URL ì—…ë°ì´íŠ¸ í•„ìš”', { newUrl: apiUrl });
        // We can't update const, but we can log the working URL
        alert(`ğŸ’¡ ì´ ëª¨ë¸ì´ ì‘ë™í•©ë‹ˆë‹¤: ${apiUrl}\n\nê°œë°œìì—ê²Œ ì´ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!`);
      }
      
      return true;
    } else {
      addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ ì‘ë‹µ êµ¬ì¡° ì˜¤ë¥˜ - candidates ì—†ìŒ', { data });
      alert('âš ï¸ APIëŠ” ì—°ê²°ë˜ì—ˆì§€ë§Œ ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.');
      return false;
    }
    
  } catch (error) {
    addDebugLog('íŠ¹ì • ëª¨ë¸ í…ŒìŠ¤íŠ¸ API ì—°ê²° ì˜¤ë¥˜', { 
      error: error.message, 
      stack: error.stack 
    });
    alert(`âŒ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!\nëª¨ë¸: ${apiUrl}\nì˜¤ë¥˜: ${error.message}`);
    return false;
  } finally {
    addDebugLog('=== íŠ¹ì • ëª¨ë¸ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
  }
}

// Initialize app on page load
// Data Management Functions
let selectedAddressesForReset = new Set();

function updateDataStatus() {
  const totalAddresses = document.getElementById('total-addresses');
  if (totalAddresses) {
    totalAddresses.textContent = ì£¼ì†Œëª©ë¡.length;
  }
}

function showDataOptions() {
  document.getElementById('dataModal').classList.add('show');
}

function showResetOptions() {
  document.getElementById('dataModal').classList.remove('show');
  document.getElementById('resetModal').classList.add('show');
}

function showAddressSelector() {
  if (ì£¼ì†Œëª©ë¡.length === 0) {
    alert('ì‚­ì œí•  ì¶œì¥ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  document.getElementById('resetModal').classList.remove('show');
  document.getElementById('addressSelectorModal').classList.add('show');
  
  // Populate address list
  const container = document.getElementById('address-selector-list');
  container.innerHTML = '';
  
  ì£¼ì†Œëª©ë¡.forEach((addr, index) => {
    const status = statusMap[addr] || 'ë¯¸ì„ íƒ';
    const hasData = statusMap[addr] || memoMap[addr] || (photoMap[addr] && photoMap[addr].length > 0);
    
    const item = document.createElement('div');
    item.className = 'option-card';
    item.style.cssText = `
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      border: 2px solid #e1e5e9;
      transition: all 0.3s ease;
      ${selectedAddressesForReset.has(addr) ? 'border-color: #e74c3c; background: rgba(231, 76, 60, 0.1);' : ''}
    `;
    
    item.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600; margin-bottom: 5px;">${addr}</div>
          <div style="font-size: 0.9rem; color: #666;">
            ìƒíƒœ: ${status}
            ${hasData ? ' â€¢ ê¸°ë¡ ìˆìŒ' : ' â€¢ ê¸°ë¡ ì—†ìŒ'}
          </div>
        </div>
        <div style="font-size: 1.2rem;">
          ${selectedAddressesForReset.has(addr) ? 'âœ“' : 'â—‹'}
        </div>
      </div>
    `;
    
    item.onclick = () => toggleAddressSelection(addr, item);
    container.appendChild(item);
  });
}

function toggleAddressSelection(address, element) {
  if (selectedAddressesForReset.has(address)) {
    selectedAddressesForReset.delete(address);
    element.style.borderColor = '#e1e5e9';
    element.style.background = '';
    element.querySelector('div:last-child').textContent = 'â—‹';
  } else {
    selectedAddressesForReset.add(address);
    element.style.borderColor = '#e74c3c';
    element.style.background = 'rgba(231, 76, 60, 0.1)';
    element.querySelector('div:last-child').textContent = 'âœ“';
  }
  
  // Show/hide reset button
  const resetBtn = document.getElementById('reset-selected-btn');
  if (selectedAddressesForReset.size > 0) {
    resetBtn.style.display = 'block';
    resetBtn.textContent = `ğŸ—‘ï¸ ì„ íƒëœ ${selectedAddressesForReset.size}ê°œ í•­ëª© ì‚­ì œ`;
  } else {
    resetBtn.style.display = 'none';
  }
}

function resetSelectedAddresses() {
  if (selectedAddressesForReset.size === 0) return;
  
  const confirmMsg = `ì„ íƒëœ ${selectedAddressesForReset.size}ê°œ ì¶œì¥ì§€ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œë  í•­ëª©:\n${Array.from(selectedAddressesForReset).join('\n')}\n\nì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
  
  if (!confirm(confirmMsg)) return;
  
  // Remove selected addresses from all data structures
  selectedAddressesForReset.forEach(addr => {
    const index = ì£¼ì†Œëª©ë¡.indexOf(addr);
    if (index > -1) {
      ì£¼ì†Œëª©ë¡.splice(index, 1);
    }
    delete statusMap[addr];
    delete memoMap[addr];
    delete photoMap[addr];
    delete originalPhotoMap[addr];
    viewedAddresses.delete(addr);
  });
  
  // Save to localStorage
  saveAddressList();
  localStorage.setItem('statusMap', JSON.stringify(statusMap));
  localStorage.setItem('memoMap', JSON.stringify(memoMap));
  localStorage.setItem('photoMap', JSON.stringify(photoMap));
  saveViewedAddresses();
  
  // Reset selection
  selectedAddressesForReset.clear();
  
  // Update UI
  updateDataStatus();
  updateAddressPreview();
  updateTravelMode();
  
  alert(`ì„ íƒëœ ì¶œì¥ì§€ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
  closeModal();
}

function confirmFullReset() {
  const confirmMsg = 'ëª¨ë“  ì¶œì¥ì§€ì™€ ê¸°ë¡ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‹¤ìŒ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤:\n- ëª¨ë“  ì¶œì¥ì§€ ëª©ë¡\n- ëª¨ë“  ì¶œì¥ ìƒíƒœ\n- ëª¨ë“  ë©”ëª¨\n- ëª¨ë“  ì‚¬ì§„\n\nì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  
  if (!confirm(confirmMsg)) return;
  
  // Clear all data
  ì£¼ì†Œëª©ë¡ = [];
  statusMap = {};
  memoMap = {};
  photoMap = {};
  viewedAddresses.clear();
  AppState.currentAddress = null;
  
  // Clear localStorage
  localStorage.removeItem('addressList');
  localStorage.removeItem('statusMap');
  localStorage.removeItem('memoMap');
  localStorage.removeItem('photoMap');
  localStorage.removeItem('viewedAddresses');
  
  // Update UI
  updateDataStatus();
  updateAddressPreview();
  updateTravelMode();
  
  alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  closeModal();
}

function continueWithExistingData() {
  closeModal();
}

function closeModal() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.classList.remove('show');
  });
  selectedAddressesForReset.clear();
}

document.addEventListener('DOMContentLoaded', function() {
  // Set initial map preference
  document.getElementById('mapSelect').value = preferredMap;
  
  // Update data status
  updateDataStatus();
  
  // Initialize first mode
  selectMode('prepare');
  
  // Update previews if data exists
  if (ì£¼ì†Œëª©ë¡.length > 0) {
    updateAddressPreview();
  }
  
  // Initialize map selection UI
  updateMapSelection();
});


// Legacy compatibility functions (empty implementations)
function showTab() {} // No longer used
function saveMemo() {} // Replaced by saveRecord
function showDropdown() {} // No longer used
function handleStatusChange() {} // Replaced by handleRecordStatusChange
function saveStatus() {} // Replaced by saveRecord
function openMapInNewTab() {} // Replaced by openMapForAddress


</script>
</body>
</html>

