<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì§„ì¶œë¡œ â€“ ì¶œì¥ê¸¸ ë„ìš°ë¯¸</title>
  <style>
     .dropdown-item.memo-marked::after {
    content: "\1F4DD"; /* ğŸ“ */
    float: right;
    margin-left: 8px;
    font-size: 1rem;
  }
   .photo-preview {
    width: 100px;
    height: 80px;
    border-radius: 6px;
    border: 1px solid #ccc;
    object-fit: cover;
    cursor: pointer;
  }
   .photo-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
   }
     #customDropdown {
    position: absolute;
    z-index: 1000;
    background-color: white;
    width: calc(100% - 22px);
  }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 10px;
    }
    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }
    header > div {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    header img {
      height: 36px;
      cursor: pointer;
    }
    header span {
      color: #1b3c82;
    }
    header .sub {
      color: #555;
    }
    #bannerImage {
      width: 100%;
      max-width: 100%;
      display: none;
      margin-top: 8px;
      border-radius: 8px;
    }
  .tabs {
  display: flex;
  justify-content: center;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 8px;
  margin-bottom: 10px;
}
.tabs button {
  flex: 0 1 auto; /* ì¤„ì–´ë“¤ê±°ë‚˜ ëŠ˜ì–´ë‚˜ì§€ ì•Šë„ë¡ ì¡°ì • */
  white-space: nowrap;
  padding: 8px 16px;
}
    .tabs button.active {
      background-color: #1b3c82;
      color: #fff;
    }
    .tab-content {
      display: none;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tab-content.active {
      display: block;
    }
    .card-ui {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      padding: 15px;
      margin-bottom: 15px;

    }
    input[type="text"], input[type="file"], select, button, textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    #customStatusInput {
      background-color: #fff8dc;
      border-color: #f0c36d;
    }
    textarea {
      resize: vertical;
      height: 100px;
    }
    .dropdown-item {
      padding: 6px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .dropdown-item.viewed {
      background-color: #e0f7fa;
    }
    .status-marked {
      font-weight: bold;
    }
    canvas {
      width: 100%;
      max-width: 400px;
      height: auto;
      display: block;
      margin: 10px auto;
    }
    #chartTextOutput {
      margin-top: 10px;
      text-align: center;
      font-size: 0.9rem;
    }
tr.status-ì¶œì¥ì™„ë£Œ { background-color: #e8f5e9; }
tr.status-ë¯¸ì¶œì¥ { background-color: #ffebee; }
tr.status-ë¯¸ì„ íƒ { background-color: #eceff1; }

/* ê¸°íƒ€ ì§ì ‘ì…ë ¥ ìƒíƒœ (ì»¤ìŠ¤í…€) */
tr.status-ì§ì ‘ì…ë ¥ {
  background-color: #fff9c4; /* ì—°ë…¸ë‘ */
}
    footer {
      display: flex;
      justify-content: center;
      align-items: center;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 12px;
      margin-top: 30px;
      font-size: 0.8rem;
      color: #888;
    }
  </style>
</head>
<body>
<header>
  <div>
    <img src="https://www.gwangjin.go.kr/editorUpload/images/000196/20221007110449234_IXETSNKL.png"
         alt="ê´‘ì§„êµ¬ CI"
         onclick="showTab('manage', event)">
    <div style="text-align: left; line-height: 1.0;">
  <div style="font-size: 1.3rem; font-weight: bold; color: #1b3c82;">
    ì§„ì¶œë¡œ <span style="font-size: 1.2rem;">(é€²å‡ºè·¯)</span>
  </div>
  <div style="font-size: 1.3rem; color: #555; font-weight: bold;">
    :ì¶œì¥ê¸¸ ë„ìš°ë¯¸
  </div>
</div>

</div>
  </div>
  <img id="bannerImage" src="" alt="ë°°ë„ˆ ì´ë¯¸ì§€">
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="manage">ì£¼ì†Œ ê´€ë¦¬</button>
  <button class="tab-btn" data-tab="table">ì „ì²´ ëª©ë¡</button>
  <button class="tab-btn" data-tab="stats">í†µê³„ ë³´ê¸°</button>
</div>

<div id="tab-manage" class="tab-content active">


<div class="card-ui">
  <label for="mapSelect" style="font-weight: bold;">ğŸ—ºï¸ ì§€ë„ ì•± ì„ íƒ</label>
  <select id="mapSelect" onchange="saveMapPreference()">
    <option value="naver">ë„¤ì´ë²„ì§€ë„</option>
    <option value="kakao">ì¹´ì¹´ì˜¤ë§µ</option>
    <option value="google">êµ¬ê¸€ì§€ë„</option>
  </select>

</div>    
<div class="card-ui">
  <label for="addrInput" style="font-weight: bold;">ğŸ  ì£¼ì†Œ ì„ íƒ</label>
  <input
  id="addrInput"
  name="no_autofill"
  type="text"
  placeholder="ì €ì¥ëœ ì£¼ì†Œ ì„ íƒí•˜ê¸°(ì—…ë¡œë“œ/ë³µì‚¬+ë¶™ì—¬ë„£ê¸°)"
  autocomplete="off"
  autocorrect="off"
  spellcheck="false"
  onfocus="this.value=''; showDropdown();"
  oninput="showDropdown()"
  onclick="showDropdown()"
/>
<div id="memoSection" class="card-ui" style="display:none;">
  <label for="memoInput" style="font-weight: bold;">ğŸ“ í˜„ì¥ ë©”ëª¨</label>
  <textarea id="memoInput" placeholder="í˜„ì¥ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì°¸ê³  ë©”ëª¨ë¥¼ ë‚¨ê¸°ì„¸ìš”."></textarea>

  <label style="font-weight: bold;">ğŸ“¸ í˜„ì¥ ì‚¬ì§„ (ìµœëŒ€ 5ì¥)</label>
  <input type="file" id="photoInput" accept="image/*" multiple onchange="savePhoto()">
  <div id="photoContainer" class="photo-grid"></div>

  <button onclick="saveMemo()">ğŸ’¾ ì €ì¥</button>
</div>

  <div id="customDropdown" style="display:none; border:1px solid #ccc; max-height:200px; overflow-y:auto; border-radius:6px;"></div>
</div>
 
 <div class="card-ui">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
    <label for="statusSelect" style="font-weight: bold;">ğŸ“ ì¶œì¥ ìƒíƒœ ì„ íƒ</label>
    <label style="font-size: 0.9rem;">
      <input type="checkbox" id="memoModeToggle" onchange="saveMemoMode()"> ğŸ“ë©”ëª¨ì „ìš©ëª¨ë“œ
    </label>
  </div>
  
  <select id="statusSelect" onchange="handleStatusChange()">
    <option value="" disabled selected hidden>ì„ íƒ / ë©”ëª¨ ë‚¨ê¸°ê¸°</option>
    <option value="ì¶œì¥ì™„ë£Œ">ì¶œì¥ì™„ë£Œ</option>
    <option value="ë¯¸ì¶œì¥">ë¯¸ì¶œì¥</option>
    <option value="ì§ì ‘ì…ë ¥">ì§ì ‘ì…ë ¥ (ì•„ë˜ ì…ë ¥)</option>
  </select>
  
  <input id="customStatusInput" type="text" maxlength="100" placeholder="ìƒíƒœ ì§ì ‘ ì…ë ¥ (100ì ì´ë‚´)" style="display:none;" oninput="saveStatus()">
</div>

<hr style="border: none; height: 4px; background-color: #ccc; margin: 0 0 15px 0;">
<div class="card-ui">
  <label for="fileUpload" style="font-weight: bold;">ğŸ“ ì£¼ì†Œ íŒŒì¼ ì—…ë¡œë“œ</label>
  <input id="fileUpload" type="file" accept=".txt,.csv" onchange="loadAddressFile(event)">
</div>

  <div class="card-ui">
    <label for="bulkPaste" style="font-weight: bold;">ğŸ“‹ ì£¼ì†Œ ë³µì‚¬í•´ì„œ ì…ë ¥</label>
    <textarea id="bulkPaste" placeholder="ì£¼ì†Œë¥¼ ì¤„ ë‹¨ìœ„ë¡œ ë³µì‚¬í•´ ë¶™ì—¬ë„£ê³  ë°‘ì— ì €ì¥ë²„íŠ¼ í´ë¦­"></textarea>
    <button onclick="addFromTextarea()">ğŸ“‹ ë¶™ì—¬ë„£ì€ ì£¼ì†Œ ì €ì¥</button>
  </div>

  <div class="card-ui" style="display: flex; gap: 10px;">
    <button onclick="resetAddressList()">ğŸ“‚ ì£¼ì†Œ ì´ˆê¸°í™”</button>
    <button onclick="resetStatusMap()">ğŸ§¹ ìƒíƒœ ì´ˆê¸°í™”</button>
  </div>
</div>

<div id="tab-table" class="tab-content">
  <div class="card-ui">
  <div id="tableSummary">ì´ 0ê±´</div>
  <button onclick="copyTable()">ğŸ“„ ë³µì‚¬í•˜ê¸°</button>
  <button onclick="exportText()">ğŸ“ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
  <button onclick="exportText()">ğŸ“¥ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button> <!-- âœ… ì¶”ê°€ -->
  <table style="width:100%; font-size:0.9rem;">
    <thead><tr><th>ì£¼ì†Œ</th><th>ìƒíƒœ</th></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

</div>

<div id="tab-stats" class="tab-content">
  <div class="card-ui">
    <div id="statsCount" style="text-align:center; font-weight:bold; margin-bottom:10px;"></div>
    <canvas id="statusChart" width="400" height="300"></canvas>
    <div id="chartTextOutput"></div>
  </div>
</div>

<footer>
  (c) 2025 ê´‘ì§„êµ¬ì²­ ê°€ë¡œê²½ê´€ê³¼ ê°œì¹œì ˆí•œ ë¥˜ì£¼ì„
</footer>
  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
const originalPhotoMap = {};
let memoMode = localStorage.getItem("memoMode") === "true";
let preferredMap = localStorage.getItem("preferredMap") || "naver";
let statusMap = JSON.parse(localStorage.getItem("statusMap")) || {};
let memoMap = JSON.parse(localStorage.getItem("memoMap")) || {};
let photoMap = JSON.parse(localStorage.getItem("photoMap")) || {};
let ì£¼ì†Œëª©ë¡ = [];
let currentAddress = null;
let viewedAddresses = new Set();
let useAppDefault = localStorage.getItem("useApp") !== "false";
  
function deletePhoto(index) {
  if (!currentAddress) return;
  if (photoMap[currentAddress]) photoMap[currentAddress].splice(index, 1);
  localStorage.setItem("photoMap", JSON.stringify(photoMap));
  renderPhotos();
}

function handlePhotoClick(index) {
  const imgUrl = originalPhotoMap[currentAddress]?.[index];
  if (!imgUrl) return;
  const dialog = document.createElement("div");
  dialog.style.position = "fixed";
  dialog.style.top = "50%";
  dialog.style.left = "50%";
  dialog.style.transform = "translate(-50%, -50%)";
  dialog.style.background = "white";
  dialog.style.padding = "20px";
  dialog.style.border = "1px solid #ccc";
  dialog.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
  dialog.style.zIndex = 9999;
  dialog.innerHTML = `
    <p style="margin-bottom: 10px;">ì‚¬ì§„ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”:</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button id="viewBtn">ğŸ“· í¬ê²Œ ë³´ê¸°</button>
      <button id="deleteBtn">âŒ ì‚­ì œ</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>
  `;
  document.body.appendChild(dialog);

  document.getElementById("viewBtn").onclick = () => {
    const popup = window.open("", "_blank");
    popup.document.write(`<img src='${imgUrl}' style='max-width:100%; height:auto;'>`);
    document.body.removeChild(dialog);
  };
  document.getElementById("deleteBtn").onclick = () => {
    deletePhoto(index);
    document.body.removeChild(dialog);
  };
  document.getElementById("cancelBtn").onclick = () => {
    document.body.removeChild(dialog);
  };
}
  
function renderPhotos() {
  const container = document.getElementById("photoContainer");
  if (!container || !currentAddress) return;

  container.innerHTML = "";
  const photos = Array.isArray(photoMap[currentAddress]) ? photoMap[currentAddress] : [];
  if (!Array.isArray(originalPhotoMap[currentAddress])) originalPhotoMap[currentAddress] = [...photos];

  photos.forEach((url, i) => {
    const img = document.createElement("img");
    img.src = url;
    img.className = "photo-preview";
    img.setAttribute("data-index", i);
    img.onclick = () => handlePhotoClick(i);
    container.appendChild(img);
  });
}

  
function exportText() {
  const wb = XLSX.utils.book_new();
  const data = [["ì£¼ì†Œ", "ìƒíƒœ", "ë©”ëª¨", "ì‚¬ì§„1", "ì‚¬ì§„2", "ì‚¬ì§„3", "ì‚¬ì§„4", "ì‚¬ì§„5"]];
  ì£¼ì†Œëª©ë¡.forEach(addr => {
    const status = statusMap[addr] || "ë¯¸ì„ íƒ";
    const memo = memoMap[addr] || "";
    const photos = Array.isArray(photoMap[addr]) ? photoMap[addr] : [];
    const links = photos.map(url => ({ l: { Target: url }, t: url }));
    const limitedMemo = memo.length > 10000 ? memo.slice(0, 10000) + "..." : memo;
    const row = [addr, status, limitedMemo, ...photos.slice(0, 5)];
    while (row.length < 8) row.push("");
    data.push(row);
  });
  const ws = XLSX.utils.aoa_to_sheet(data);

  // ì‚¬ì§„ ë§í¬ ì…€ì— í•˜ì´í¼ë§í¬ ì¶”ê°€
  data.forEach((row, rowIndex) => {
    if (rowIndex === 0) return; // í—¤ë” ì œì™¸
    for (let i = 3; i <= 7; i++) {
      const cellAddr = XLSX.utils.encode_cell({ r: rowIndex, c: i });
      const val = row[i];
      if (val && typeof val === "string") {
        ws[cellAddr].l = { Target: val };
      }
    }
  });

  XLSX.utils.book_append_sheet(wb, ws, "ì¶œì¥ê¸°ë¡");
  XLSX.writeFile(wb, "ì¶œì¥ê¸°ë¡.xlsx");
}

  
  function isIOS() {
  return /iphone|ipad|ipod/i.test(navigator.userAgent);
}


function saveMemoMode() {
  memoMode = document.getElementById("memoModeToggle").checked;
  localStorage.setItem("memoMode", memoMode);
}

document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("memoModeToggle");
  if (toggle) toggle.checked = memoMode;
});


document.addEventListener("DOMContentLoaded", function() {
  // ìƒíƒœë§µ, ì§€ë„ì•±ì€ ì´ë¯¸ ë³µì› ì¤‘
  const savedViewed = localStorage.getItem("viewedAddresses");
if (savedViewed) {
  viewedAddresses = new Set(JSON.parse(savedViewed));
}

  const savedList = localStorage.getItem("addressList");
  if (savedList) {
    ì£¼ì†Œëª©ë¡ = JSON.parse(savedList);
  }

  document.getElementById("mapSelect").value = preferredMap;
  document.querySelectorAll(".tab-btn").forEach(button => {
    button.addEventListener("click", function(e) {
      const tabId = this.getAttribute("data-tab");
      showTab(tabId, e);
    });
  });

  showTab("manage");
});


function showTab(tabId, event = null) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  if (event) event.target.classList.add('active');
  else document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
  if (tabId === "table") updateTable();
  if (tabId === "stats") drawChart();
}

function saveMapPreference() {
  preferredMap = document.getElementById("mapSelect").value;
  localStorage.setItem("preferredMap", preferredMap);
}

function saveMemo() {
  if (!currentAddress) return;
  const memoInput = document.getElementById("memoInput");
  const memo = memoInput.value.trim();
  if (!memo) {
    delete memoMap[currentAddress];
  } else {
    const now = new Date();
    const datePrefix = now.toISOString().slice(0, 10);
    const timePrefix = now.toTimeString().slice(0, 5);
    memoMap[currentAddress] = `${datePrefix} ${timePrefix} - ${memo}`;
  }
  localStorage.setItem("memoMap", JSON.stringify(memoMap));
  localStorage.setItem("photoMap", JSON.stringify(photoMap));
  alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  document.getElementById("customDropdown").style.display = "block";
  showDropdown();
}
function resizeImage(base64, maxWidth, maxHeight, callback) {
  const img = new Image();
  img.onload = function () {
    const canvas = document.createElement("canvas");
    let width = img.width;
    let height = img.height;
    const ratio = Math.min(1024 / width, 1024 / height, 1);
    width = width * ratio;
    height = height * ratio;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, width, height);
    const resizedBase64 = canvas.toDataURL("image/jpeg", 0.85);
    callback(resizedBase64);
  };
  img.src = base64;
}

function uploadToImgur(base64Image, callback) {
  const base64 = base64Image.replace(/^data:image\/\w+;base64,/, "");
  fetch("https://api.imgur.com/3/image", {
    method: "POST",
    headers: {
      Authorization: "Client-ID a0058fd0a6e3657",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      image: base64,
      type: "base64"
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      callback(data.data.link);
    } else {
      alert("Imgur ì—…ë¡œë“œ ì‹¤íŒ¨");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Imgur ì—…ë¡œë“œ ì˜¤ë¥˜ ë°œìƒ");
  });
}

function savePhoto() {
  const input = document.getElementById("photoInput");
  const files = input.files;
  if (!files || !currentAddress) return;

  if (!Array.isArray(photoMap[currentAddress])) photoMap[currentAddress] = [];
  if (!Array.isArray(originalPhotoMap[currentAddress])) originalPhotoMap[currentAddress] = [];

  const urls = photoMap[currentAddress];
  if (urls.length >= 5) {
    alert("ì‚¬ì§„ì€ ìµœëŒ€ 5ì¥ê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return;
  }

  Array.from(files).forEach(file => {
    if (!file.type.startsWith("image/")) return;
    const reader = new FileReader();
    reader.onload = e => {
      uploadToImgur(e.target.result).then(imgurUrl => {
        if (photoMap[currentAddress].length >= 5) return;
        photoMap[currentAddress].push(imgurUrl);
        originalPhotoMap[currentAddress].push(imgurUrl);
        localStorage.setItem("photoMap", JSON.stringify(photoMap));
        renderPhotos();
      });
    };
    reader.readAsDataURL(file);
  });
}

// Imgur ì—…ë¡œë“œ
function uploadToImgur(base64Image) {
  return fetch("https://api.imgur.com/3/image", {
    method: "POST",
    headers: {
      Authorization: "Client-ID a0058fd0a6e3657",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      image: base64Image.split(",")[1], // 'data:image/jpeg;base64,...'ì—ì„œ base64 ë¶€ë¶„ë§Œ ì¶”ì¶œ
      type: "base64"
    })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.data && data.data.link) {
        return data.data.link;
      } else {
        throw new Error("Imgur ì—…ë¡œë“œ ì‹¤íŒ¨");
      }
    });
}



function showDropdown() {
  const input = document.getElementById("addrInput");
  const dropdown = document.getElementById("customDropdown");
  const inputRect = input.getBoundingClientRect();
  dropdown.innerHTML = "";
  dropdown.style.top = input.offsetTop + input.offsetHeight + "px";
  dropdown.style.left = input.offsetLeft + "px";
  dropdown.style.display = "block";

  ì£¼ì†Œëª©ë¡.filter(addr => addr.includes(input.value)).forEach(addr => {
    const div = document.createElement("div");
    div.className = "dropdown-item";
    if (viewedAddresses.has(addr)) div.classList.add("viewed");
    if (statusMap[addr]) div.classList.add("status-marked");
    if (memoMap[addr]) div.classList.add("memo-marked");

    div.textContent = statusMap[addr] ? addr + " [" + statusMap[addr] + "]" : addr;
    div.onclick = () => {
      currentAddress = addr;
      viewedAddresses.add(addr);
      saveViewedAddresses();
      document.getElementById("addrInput").value = addr;
      document.getElementById("statusSelect").value = statusMap[addr] || "";

      const value = statusMap[addr] || "";
      const customInput = document.getElementById("customStatusInput");
      if (!["ì¶œì¥ì™„ë£Œ", "ë¯¸ì¶œì¥", ""].includes(value)) {
        document.getElementById("statusSelect").value = "ì§ì ‘ì…ë ¥";
        customInput.style.display = "block";
        customInput.value = value;
      } else {
        customInput.style.display = "none";
        customInput.value = "";
      }

      document.getElementById("memoInput").value = memoMap[addr] || "";
      document.getElementById("memoSection").style.display = "block";

      renderPhotos();

      dropdown.style.display = "none";

      if (!memoMode) openMapInNewTab();
    };

    dropdown.appendChild(div);
  });
}
  

  function openMapInNewTab() {
  const addr = currentAddress || document.getElementById("addrInput").value.trim();
  if (!addr) return alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  const baseAddr = addr.replace(/\s*\([^)]*\)\s*$/, '').trim();
  const encodedAddr = encodeURIComponent(baseAddr);
  const mapType = preferredMap;

  let url = "";
  if (mapType === "naver") {
    url = `https://map.naver.com/v5/search/${encodedAddr}`;
  } else if (mapType === "kakao") {
    url = `https://map.kakao.com/?q=${encodedAddr}`;
  } else if (mapType === "google") {
    url = `https://www.google.com/maps/search/?api=1&query=${encodedAddr}`;
  }

  // âŒ ì˜ëª»ëœ ë¬´í•œ ì¬ê·€ í˜¸ì¶œ ì œê±°
  // âœ… í•„ìš”ì‹œ ì¡°ê±´ë¶€ openMapInNewTab í˜¸ì¶œì€ ì™¸ë¶€ì—ì„œ ì œì–´í•˜ë„ë¡
  window.open(url, "_blank");
}


function handleStatusChange() {
  const select = document.getElementById("statusSelect");
  const customInput = document.getElementById("customStatusInput");
  if (select.value === "ì§ì ‘ì…ë ¥") {
    customInput.style.display = "block";
  } else {
    customInput.style.display = "none";
    saveStatus();
  }
}
 function saveAddressList() {
  localStorage.setItem("addressList", JSON.stringify(ì£¼ì†Œëª©ë¡));
}


function saveStatus() {
  const select = document.getElementById("statusSelect");
  const input = document.getElementById("customStatusInput");
  let status = select.value;
  if (status === "ì§ì ‘ì…ë ¥") {
    status = input.value.trim().substring(0, 100);
  }
  if (!currentAddress) return;
  if (!status) delete statusMap[currentAddress];
  else statusMap[currentAddress] = status;
  localStorage.setItem("statusMap", JSON.stringify(statusMap));
}
function saveViewedAddresses() {
  localStorage.setItem("viewedAddresses", JSON.stringify([...viewedAddresses]));
}

function loadAddressFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split(/\r?\n/).filter(line => line.trim());
    const newList = [];
    let added = 0;

    lines.forEach(line => {
      const [addr, status] = line.split('\t');
      const trimmedAddr = addr?.trim();
      if (trimmedAddr && !ì£¼ì†Œëª©ë¡.includes(trimmedAddr)) {
        newList.push(trimmedAddr);
        if (status) statusMap[trimmedAddr] = status.trim();
        added++;
      } else if (trimmedAddr && status) {
        statusMap[trimmedAddr] = status.trim();
      }
    });

    ì£¼ì†Œëª©ë¡ = [...ì£¼ì†Œëª©ë¡, ...newList];
    alert(`ì£¼ì†Œ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ${lines.length}ê±´ ì¤‘ ${added}ê±´ ì¶”ê°€ë¨ (ì´ ${ì£¼ì†Œëª©ë¡.length}ê±´)`);

    // âœ… ì—¬ê¸°ì— ì €ì¥ ë¡œì§ í¬í•¨
    saveAddressList();
    localStorage.setItem("statusMap", JSON.stringify(statusMap));
  };

  reader.readAsText(file, 'UTF-8');
}

function addFromTextarea() {
  const input = document.getElementById("bulkPaste").value;
  if (!input) return;
  const lines = input.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const newList = lines.filter(l => !ì£¼ì†Œëª©ë¡.includes(l));
  ì£¼ì†Œëª©ë¡ = [...ì£¼ì†Œëª©ë¡, ...newList];
  saveAddressList();
  alert(`${newList.length}ê°œì˜ ì£¼ì†Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  document.getElementById("bulkPaste").value = "";
}

function resetAddressList() {
  ì£¼ì†Œëª©ë¡ = [];
  currentAddress = null;
  document.getElementById("addrInput").value = "";
  document.getElementById("customDropdown").innerHTML = "";
  saveAddressList();
  alert("ì£¼ì†Œ ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function resetStatusMap() {
  statusMap = {};
  localStorage.removeItem("statusMap");
  alert("ìƒíƒœ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

function updateTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  ì£¼ì†Œëª©ë¡.forEach(addr => {
    const rawStatus = statusMap[addr] || "ë¯¸ì„ íƒ";
    const classStatus = ["ì¶œì¥ì™„ë£Œ", "ë¯¸ì¶œì¥", "ë¯¸ì„ íƒ"].includes(rawStatus)
      ? rawStatus
      : "ì§ì ‘ì…ë ¥";  // ì§ì ‘ì…ë ¥ì€ ì „ë¶€ ê°™ì€ ë°°ê²½ìƒ‰ ì ìš©

    const row = document.createElement("tr");
    row.className = `status-${classStatus}`;
    row.innerHTML = `<td>${addr}</td><td>${rawStatus}</td>`;
    tbody.appendChild(row);
  });
}


function copyTable() {
  let text = "ì£¼ì†Œ\tìƒíƒœ\n";
  ì£¼ì†Œëª©ë¡.forEach(addr => {
    const status = statusMap[addr] || "ë¯¸ì„ íƒ";
    text += addr + "\t" + status + "\n";
  });
  navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ ì™„ë£Œ"));
}


function drawChart() {
  const ctx = document.getElementById("statusChart").getContext("2d");
  const count = { ì¶œì¥ì™„ë£Œ: 0, ë¯¸ì¶œì¥: 0, ë¯¸ì„ íƒ: 0, ì§ì ‘ì…ë ¥: 0 };
  ì£¼ì†Œëª©ë¡.forEach(addr => {
    const status = statusMap[addr] || "ë¯¸ì„ íƒ";
    const key = ["ì¶œì¥ì™„ë£Œ", "ë¯¸ì¶œì¥", "ë¯¸ì„ íƒ"].includes(status) ? status : "ì§ì ‘ì…ë ¥";
    count[key]++;
  });
  const data = {
    labels: Object.keys(count),
    datasets: [{
      label: 'ìƒíƒœë³„ ê°œìˆ˜',
      data: Object.values(count),
      backgroundColor: ['#4caf50', '#f44336', '#90a4ae', '#ffcc80']
    }]
  };
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
  const total = Object.values(count).reduce((a, b) => a + b, 0);
  document.getElementById("statsCount").innerText = `ì´ í•­ëª© ìˆ˜: ${total}ê±´`;
  document.getElementById("chartTextOutput").innerText =
    Object.entries(count).map(([k,v]) => `${k}: ${v}ê±´`).join(' / ');
}
</script>
</body>
</html>
